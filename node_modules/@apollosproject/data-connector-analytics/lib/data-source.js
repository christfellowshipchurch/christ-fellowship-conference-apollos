"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.getInterfaces = void 0;

var _apolloServer = require("apollo-server");

var _apolloDatasource = require("apollo-datasource");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _ga = _interopRequireDefault(require("./interfaces/ga"));

var _segment = _interopRequireDefault(require("./interfaces/segment"));

var _rock_interactions = _interopRequireDefault(require("./interfaces/rock_interactions"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  ANALYTICS
} = _config.default; // Utility function to convert GQL array of key/values to Object.

const mapArrayToObject = (array = []) => array.reduce((accum, {
  field,
  value
}) => {
  // eslint-disable-next-line no-param-reassign
  accum[field] = value;
  return accum;
}, {}); // Add interfaces to this function to get picked up automatically.


const getInterfaces = () => {
  const interfaces = [new _rock_interactions.default()];

  if (ANALYTICS.SEGMENT_KEY) {
    interfaces.push(new _segment.default(ANALYTICS.SEGMENT_KEY));
  }

  if (ANALYTICS.GA_ID) {
    interfaces.push(new _ga.default(ANALYTICS.GA_ID));
  }

  return interfaces;
};

exports.getInterfaces = getInterfaces;

class Analytics extends _apolloDatasource.DataSource {
  // Interfaces should extend BaseInterface in the interfaces folder.
  // They should extend BaseAnalytics and implement
  // track({ event: String, anonymousId: String, userId: String, properties: Obj, context: Obj })
  // and
  // track({ event: String, anonymousId: String, userId: String, traits: Obj, context: Obj })
  constructor(interfaces = []) {
    super();
    this.interfaces = interfaces.length ? interfaces : getInterfaces();
  } // Called automatically b/c extends DataSource.


  initialize({
    context
  }) {
    this.context = context;
    this.interfaces.forEach(iface => {
      iface.initialize({
        context
      });
    });
  }

  get identifyInterfaces() {
    return this.interfaces.filter(i => i.shouldIdentify);
  }

  get trackInterfaces() {
    return this.interfaces.filter(i => i.shouldTrack);
  } // Shorthand to get Auth module.


  get Auth() {
    return this.context.dataSources.Auth;
  }

  async getCurrentPerson() {
    let user;

    try {
      user = await this.Auth.getCurrentPerson();
    } catch (e) {
      if (!(e instanceof _apolloServer.AuthenticationError)) {
        throw e;
      }
    }

    return user;
  } // Called via the `identify` mutation.
  // traits is an array of objects matching the pattern [{ field: String, value: String}]


  async identify({
    anonymousId,
    deviceInfo,
    traits
  }) {
    const currentUser = await this.getCurrentPerson();
    this.identifyInterfaces.forEach(async iface => {
      const parsedTraits = mapArrayToObject(traits);
      iface.identify({
        userId: currentUser && currentUser.id,
        anonymousId,
        traits: {
          firstName: currentUser.firstName,
          lastName: currentUser.lastName,
          email: currentUser.email,
          ...parsedTraits
        },
        context: deviceInfo
      });
    });
    return {
      success: true
    };
  } // Called via the `track` mutation.
  // properties is an array of objects matching the pattern [{ field: String, value: String}]


  async track({
    anonymousId,
    deviceInfo,
    eventName,
    properties
  }) {
    const currentUser = await this.getCurrentPerson();
    const parsedProps = mapArrayToObject(properties);
    this.trackInterfaces.forEach(async iface => {
      if (iface.eventWhitelist === null || iface.eventWhitelist.includes(eventName)) {
        iface.track({
          userId: currentUser && currentUser.id,
          anonymousId,
          properties: parsedProps,
          event: eventName,
          context: deviceInfo,
          sessionId: this.context.sessionId // used for the rock interface

        });
      }
    });
    return {
      success: true
    };
  }

}

exports.default = Analytics;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kYXRhLXNvdXJjZS5qcyJdLCJuYW1lcyI6WyJBTkFMWVRJQ1MiLCJBcG9sbG9zQ29uZmlnIiwibWFwQXJyYXlUb09iamVjdCIsImFycmF5IiwicmVkdWNlIiwiYWNjdW0iLCJmaWVsZCIsInZhbHVlIiwiZ2V0SW50ZXJmYWNlcyIsImludGVyZmFjZXMiLCJSb2NrSW50ZXJhY3Rpb25zIiwiU0VHTUVOVF9LRVkiLCJwdXNoIiwiU2VnbWVudEludGVyZmFjZSIsIkdBX0lEIiwiR0FJbnRlcmZhY2UiLCJBbmFseXRpY3MiLCJEYXRhU291cmNlIiwiY29uc3RydWN0b3IiLCJsZW5ndGgiLCJpbml0aWFsaXplIiwiY29udGV4dCIsImZvckVhY2giLCJpZmFjZSIsImlkZW50aWZ5SW50ZXJmYWNlcyIsImZpbHRlciIsImkiLCJzaG91bGRJZGVudGlmeSIsInRyYWNrSW50ZXJmYWNlcyIsInNob3VsZFRyYWNrIiwiQXV0aCIsImRhdGFTb3VyY2VzIiwiZ2V0Q3VycmVudFBlcnNvbiIsInVzZXIiLCJlIiwiQXV0aGVudGljYXRpb25FcnJvciIsImlkZW50aWZ5IiwiYW5vbnltb3VzSWQiLCJkZXZpY2VJbmZvIiwidHJhaXRzIiwiY3VycmVudFVzZXIiLCJwYXJzZWRUcmFpdHMiLCJ1c2VySWQiLCJpZCIsImZpcnN0TmFtZSIsImxhc3ROYW1lIiwiZW1haWwiLCJzdWNjZXNzIiwidHJhY2siLCJldmVudE5hbWUiLCJwcm9wZXJ0aWVzIiwicGFyc2VkUHJvcHMiLCJldmVudFdoaXRlbGlzdCIsImluY2x1ZGVzIiwiZXZlbnQiLCJzZXNzaW9uSWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFnQkMsZUFBdEIsQyxDQUNBOztBQUNBLE1BQU1DLGdCQUFnQixHQUFHLENBQUNDLEtBQUssR0FBRyxFQUFULEtBQ3ZCQSxLQUFLLENBQUNDLE1BQU4s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QSxPQUFPLEVBQUU7QUFBWCxLQUFQO0FBQ0Q7O0FBdEYrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF1dGhlbnRpY2F0aW9uRXJyb3IgfSBmcm9tICdhcG9sbG8tc2VydmVyJztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICdhcG9sbG8tZGF0YXNvdXJjZSc7XG5pbXBvcnQgQXBvbGxvc0NvbmZpZyBmcm9tICdAYXBvbGxvc3Byb2plY3QvY29uZmlnJztcbmltcG9ydCBHQUludGVyZmFjZSBmcm9tICcuL2ludGVyZmFjZXMvZ2EnO1xuaW1wb3J0IFNlZ21lbnRJbnRlcmZhY2UgZnJvbSAnLi9pbnRlcmZhY2VzL3NlZ21lbnQnO1xuaW1wb3J0IFJvY2tJbnRlcmFjdGlvbnMgZnJvbSAnLi9pbnRlcmZhY2VzL3JvY2tfaW50ZXJhY3Rpb25zJztcblxuY29uc3QgeyBBTkFMWVRJQ1MgfSA9IEFwb2xsb3NDb25maWc7XG4vLyBVdGlsaXR5IGZ1bmN0aW9uIHRvIGNvbnZlcnQgR1FMIGFycmF5IG9mIGtleS92YWx1ZXMgdG8gT2JqZWN0LlxuY29uc3QgbWFwQXJyYXlUb09iamVjdCA9IChhcnJheSA9IFtdKSA9PlxuICBhcnJheS5yZWR1Y2UoKGFjY3VtLCB7IGZpZWxkLCB2YWx1ZSB9KSA9PiB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgYWNjdW1bZmllbGRdID0gdmFsdWU7XG4gICAgcmV0dXJuIGFjY3VtO1xuICB9LCB7fSk7XG5cbi8vIEFkZCBpbnRlcmZhY2VzIHRvIHRoaXMgZnVuY3Rpb24gdG8gZ2V0IHBpY2tlZCB1cCBhdXRvbWF0aWNhbGx5LlxuZXhwb3J0IGNvbnN0IGdldEludGVyZmFjZXMgPSAoKSA9PiB7XG4gIGNvbnN0IGludGVyZmFjZXMgPSBbbmV3IFJvY2tJbnRlcmFjdGlvbnMoKV07XG4gIGlmIChBTkFMWVRJQ1MuU0VHTUVOVF9LRVkpIHtcbiAgICBpbnRlcmZhY2VzLnB1c2gobmV3IFNlZ21lbnRJbnRlcmZhY2UoQU5BTFlUSUNTLlNFR01FTlRfS0VZKSk7XG4gIH1cbiAgaWYgKEFOQUxZVElDUy5HQV9JRCkge1xuICAgIGludGVyZmFjZXMucHVzaChuZXcgR0FJbnRlcmZhY2UoQU5BTFlUSUNTLkdBX0lEKSk7XG4gIH1cbiAgcmV0dXJuIGludGVyZmFjZXM7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBbmFseXRpY3MgZXh0ZW5kcyBEYXRhU291cmNlIHtcbiAgLy8gSW50ZXJmYWNlcyBzaG91bGQgZXh0ZW5kIEJhc2VJbnRlcmZhY2UgaW4gdGhlIGludGVyZmFjZXMgZm9sZGVyLlxuICAvLyBUaGV5IHNob3VsZCBleHRlbmQgQmFzZUFuYWx5dGljcyBhbmQgaW1wbGVtZW50XG4gIC8vIHRyYWNrKHsgZXZlbnQ6IFN0cmluZywgYW5vbnltb3VzSWQ6IFN0cmluZywgdXNlcklkOiBTdHJpbmcsIHByb3BlcnRpZXM6IE9iaiwgY29udGV4dDogT2JqIH0pXG4gIC8vIGFuZFxuICAvLyB0cmFjayh7IGV2ZW50OiBTdHJpbmcsIGFub255bW91c0lkOiBTdHJpbmcsIHVzZXJJZDogU3RyaW5nLCB0cmFpdHM6IE9iaiwgY29udGV4dDogT2JqIH0pXG4gIGNvbnN0cnVjdG9yKGludGVyZmFjZXMgPSBbXSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5pbnRlcmZhY2VzID0gaW50ZXJmYWNlcy5sZW5ndGggPyBpbnRlcmZhY2VzIDogZ2V0SW50ZXJmYWNlcygpO1xuICB9XG5cbiAgLy8gQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYi9jIGV4dGVuZHMgRGF0YVNvdXJjZS5cbiAgaW5pdGlhbGl6ZSh7IGNvbnRleHQgfSkge1xuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gICAgdGhpcy5pbnRlcmZhY2VzLmZvckVhY2goKGlmYWNlKSA9PiB7XG4gICAgICBpZmFjZS5pbml0aWFsaXplKHsgY29udGV4dCB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldCBpZGVudGlmeUludGVyZmFjZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJmYWNlcy5maWx0ZXIoKGkpID0+IGkuc2hvdWxkSWRlbnRpZnkpO1xuICB9XG5cbiAgZ2V0IHRyYWNrSW50ZXJmYWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy5pbnRlcmZhY2VzLmZpbHRlcigoaSkgPT4gaS5zaG91bGRUcmFjayk7XG4gIH1cblxuICAvLyBTaG9ydGhhbmQgdG8gZ2V0IEF1dGggbW9kdWxlLlxuICBnZXQgQXV0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LmRhdGFTb3VyY2VzLkF1dGg7XG4gIH1cblxuICBhc3luYyBnZXRDdXJyZW50UGVyc29uKCkge1xuICAgIGxldCB1c2VyO1xuICAgIHRyeSB7XG4gICAgICB1c2VyID0gYXdhaXQgdGhpcy5BdXRoLmdldEN1cnJlbnRQZXJzb24oKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoIShlIGluc3RhbmNlb2YgQXV0aGVudGljYXRpb25FcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cblxuICAvLyBDYWxsZWQgdmlhIHRoZSBgaWRlbnRpZnlgIG11dGF0aW9uLlxuICAvLyB0cmFpdHMgaXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBtYXRjaGluZyB0aGUgcGF0dGVybiBbeyBmaWVsZDogU3RyaW5nLCB2YWx1ZTogU3RyaW5nfV1cbiAgYXN5bmMgaWRlbnRpZnkoeyBhbm9ueW1vdXNJZCwgZGV2aWNlSW5mbywgdHJhaXRzIH0pIHtcbiAgICBjb25zdCBjdXJyZW50VXNlciA9IGF3YWl0IHRoaXMuZ2V0Q3VycmVudFBlcnNvbigpO1xuICAgIHRoaXMuaWRlbnRpZnlJbnRlcmZhY2VzLmZvckVhY2goYXN5bmMgKGlmYWNlKSA9PiB7XG4gICAgICBjb25zdCBwYXJzZWRUcmFpdHMgPSBtYXBBcnJheVRvT2JqZWN0KHRyYWl0cyk7XG4gICAgICBpZmFjZS5pZGVudGlmeSh7XG4gICAgICAgIHVzZXJJZDogY3VycmVudFVzZXIgJiYgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGFub255bW91c0lkLFxuICAgICAgICB0cmFpdHM6IHtcbiAgICAgICAgICBmaXJzdE5hbWU6IGN1cnJlbnRVc2VyLmZpcnN0TmFtZSxcbiAgICAgICAgICBsYXN0TmFtZTogY3VycmVudFVzZXIubGFzdE5hbWUsXG4gICAgICAgICAgZW1haWw6IGN1cnJlbnRVc2VyLmVtYWlsLFxuICAgICAgICAgIC4uLnBhcnNlZFRyYWl0cyxcbiAgICAgICAgfSxcbiAgICAgICAgY29udGV4dDogZGV2aWNlSW5mbyxcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfVxuXG4gIC8vIENhbGxlZCB2aWEgdGhlIGB0cmFja2AgbXV0YXRpb24uXG4gIC8vIHByb3BlcnRpZXMgaXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBtYXRjaGluZyB0aGUgcGF0dGVybiBbeyBmaWVsZDogU3RyaW5nLCB2YWx1ZTogU3RyaW5nfV1cbiAgYXN5bmMgdHJhY2soeyBhbm9ueW1vdXNJZCwgZGV2aWNlSW5mbywgZXZlbnROYW1lLCBwcm9wZXJ0aWVzIH0pIHtcbiAgICBjb25zdCBjdXJyZW50VXNlciA9IGF3YWl0IHRoaXMuZ2V0Q3VycmVudFBlcnNvbigpO1xuICAgIGNvbnN0IHBhcnNlZFByb3BzID0gbWFwQXJyYXlUb09iamVjdChwcm9wZXJ0aWVzKTtcbiAgICB0aGlzLnRyYWNrSW50ZXJmYWNlcy5mb3JFYWNoKGFzeW5jIChpZmFjZSkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBpZmFjZS5ldmVudFdoaXRlbGlzdCA9PT0gbnVsbCB8fFxuICAgICAgICBpZmFjZS5ldmVudFdoaXRlbGlzdC5pbmNsdWRlcyhldmVudE5hbWUpXG4gICAgICApIHtcbiAgICAgICAgaWZhY2UudHJhY2soe1xuICAgICAgICAgIHVzZXJJZDogY3VycmVudFVzZXIgJiYgY3VycmVudFVzZXIuaWQsXG4gICAgICAgICAgYW5vbnltb3VzSWQsXG4gICAgICAgICAgcHJvcGVydGllczogcGFyc2VkUHJvcHMsXG4gICAgICAgICAgZXZlbnQ6IGV2ZW50TmFtZSxcbiAgICAgICAgICBjb250ZXh0OiBkZXZpY2VJbmZvLFxuICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5jb250ZXh0LnNlc3Npb25JZCwgLy8gdXNlZCBmb3IgdGhlIHJvY2sgaW50ZXJmYWNlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfVxufVxuIl19