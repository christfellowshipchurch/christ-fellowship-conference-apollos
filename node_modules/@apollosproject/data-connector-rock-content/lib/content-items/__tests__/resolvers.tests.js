"use strict";

var _graphql = require("graphql");

var _apolloServerEnv = require("apollo-server-env");

var _serverCore = require("@apollosproject/server-core");

var _testUtils = require("@apollosproject/server-core/lib/testUtils");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _dataSchema = require("@apollosproject/data-schema");

var _ = require("../..");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// we import the root-level schema and resolver so we test the entire integration:
class Scripture {
  // eslint-disable-next-line class-methods-use-this
  initialize() {} // eslint-disable-next-line class-methods-use-this


  getScriptures() {
    return [{
      html: `<p class="p"><span data-number="1" class="v">1</span>The Song of songs, which is Solomonâ€™s.</p>`
    }];
  }

}

const {
  getSchema,
  getContext
} = (0, _testUtils.createTestHelpers)({
  ContentChannel: _.ContentChannel,
  ContentItem: _.ContentItem,
  Sharable: _.Sharable,
  UniversalContentItem: {
    dataSource: _.ContentItem.dataSource
  },
  // alias
  DevotionalContentItem: {
    dataSource: _.ContentItem.dataSource
  },
  // alias
  Scripture: {
    dataSource: Scripture
  }
}); // we import the root-level schema and resolver so we test the entire integration:

_config.default.loadJs({
  ROCK: {
    API_URL: 'https://apollosrock.newspring.cc/api',
    API_TOKEN: 'some-rock-token',
    IMAGE_URL: 'https://apollosrock.newspring.cc/GetImage.ashx'
  },
  ROCK_CONSTANTS: {
    IMAGE: 10,
    AUDIO_FILE: 77,
    VIDEO_FILE: 79
  },
  ROCK_MAPPINGS: {
    FEED_CONTENT_CHANNEL_IDS: [1, 2, 3, 4, 6, 8],
    SERIES_CONTENT_CHANNEL_TYPE_IDS: [6, 7]
  }
});

const contentItemFragment = `
  fragment ContentItemFragment on ContentItem {
    id
    __typename
    title
    summary
    coverImage {
      name
      key
      sources {
        uri
      }
    }
    images {
      __typename # Typenames here to increase test coverage
      name
      key
      sources {
        __typename
        uri
      }
    }
    videos {
      __typename
      name
      key
      sources {
        __typename
        uri
      }
      embedHtml
    }
    audios {
      __typename
      name
      key
      sources {
        __typename
        uri
      }
    }
    htmlContent
    childContentItemsConnection {
      edges {
        node {
          id
          __typename
        }
        cursor
      }
      pageInfo {
        startCursor
        endCursor
      }
    }
    parentChannel {
      id
      __typename
    }
    sharing {
      __typename
      url
      title
      message
    }
  }
`;
describe('UniversalContentItem', () => {
  let schema;
  let context;
  beforeEach(() => {
    _apolloServerEnv.fetch.resetMocks();

    _apolloServerEnv.fetch.mockRockDataSourceAPI();

    schema = getSchema([_dataSchema.themeSchema, _dataSchema.mediaSchema, _dataSchema.scriptureSchema]);
    context = getContext();
  });
  it('gets a user feed', async () => {
    const query = `
      query {
        userFeed {
          edges {
            node {
              ...ContentItemFragment
            }
          }
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('gets a content item', async () => {
    const query = `
      query {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}") {
          ...ContentItemFragment
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('gets a MediaContentItem item', async () => {
    const query = `
      query {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'MediaContentItem')}") {
          ...ContentItemFragment
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('gets a ContentSeriesContentItem item', async () => {
    const query = `
      query {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'ContentSeriesContentItem')}") {
          ...ContentItemFragment
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('gets a devotional item', async () => {
    const query = `
      query {
        node(id: "${(0, _serverCore.createGlobalId)(123, 'DevotionalContentItem')}") {
          id
          ... on DevotionalContentItem {
            id
            title
            scriptures {
              html
            }
          }
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it("gets a content item and it's siblings", async () => {
    const query = `
      query {
        userFeed {
          edges {
            node {
              ...ContentItemFragment
              ... on UniversalContentItem {
                siblingContentItemsConnection {
                        edges {
                    node {
                      id
                      __typename
                    }
                    cursor
                  }
                }
              }
            }
          }
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('properly handles empty attribute values', async () => {
    const query = `
      query {
        node(id: "${(0, _serverCore.createGlobalId)('test-case-no-attributes', 'UniversalContentItem')}") {
          ...ContentItemFragment
        }
      }
      ${contentItemFragment}
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
});
const {
  ContentItemsConnection,
  ContentItem: ContentItemResolver
} = _.ContentItem.resolver;
describe('ContentItem resolver', () => {
  it('fetches an item summary for an item with no description', () => {
    const item = {
      content: ''
    };
    const summary = ContentItemResolver.summary(item);
    expect(summary).toEqual('');
  });
  it('fetches an item summary for an item with a description', () => {
    const item = {
      content: 'Foo bar baz. Some other foo.'
    };
    const summary = ContentItemResolver.summary(item);
    expect(summary).toEqual('Foo bar baz.');
  });
});
describe('ContentItemsConnection resolver', () => {
  it('builds a pageInfo object with items', async () => {
    const edges = Promise.resolve([{
      cursor: `item-0`
    }, {
      cursor: `item-1`
    }, {
      cursor: `item-2`
    }]);
    const {
      startCursor,
      endCursor
    } = await ContentItemsConnection.pageInfo({
      edges
    });
    expect(startCursor).toEqual('item-0');
    expect(endCursor).toEqual('item-2');
  });
  it('builds a pageInfo object without items', async () => {
    const edges = [];
    const {
      startCursor,
      endCursor
    } = await ContentItemsConnection.pageInfo({
      edges
    });
    expect(startCursor).toEqual(null);
    expect(endCursor).toEqual(null);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb250ZW50LWl0ZW1zL19fdGVzdHNfXy9yZXNvbHZlcnMudGVzdHMuanMiXSwibmFtZXMiOlsiU2NyaXB0dXJlIiwiaW5pdGlhbGl6ZSIsImdldFNjcmlwdHVyZXMiLCJodG1sIiwiZ2V0U2NoZW1hIiwiZ2V0Q29udGV4dCIsIkNvbnRlbnRDaGFubmVsIiwiQ29udGVudEl0ZW0iLCJTaGFyYWJsZSIsIlVuaXZlcnNhbENvbnRlbnRJdGVtIiwiZGF0YVNvdXJjZSIsIkRldm90aW9uYWxDb250ZW50SXRlbSIsIkFwb2xsb3NDb25maWciLCJsb2FkSnMiLCJST0NLIiwiQVBJX1VSTCIsIkFQSV9UT0tFTiIsIklNQUdFX1VSTCIsIlJPQ0tfQ09OU1RBTlRTIiwiSU1BR0UiLCJBVURJT19GSUxFIiwiVklERU9fRklMRSIsIlJPQ0tfTUFQUElOR1MiLCJGRUVEX0NPTlRFTlRfQ0hBTk5FTF9JRFMiLCJTRVJJRVNfQ09OVEVOVF9DSEFOTkVMX1RZUEVfSURTIiwiY29udGVudEl0ZW1GcmFnbWVudCIsImRlc2NyaWJlIiwic2NoZW1hIiwiY29udGV4dCIsImJlZm9yZUVhY2giLCJmZXRjaCIsInJlc2V0TW9ja3MiLCJtb2NrUm9ja0RhdGFTb3VyY2VBUEkiLCJ0aGVtZVNjaGVtYSIsIm1lZGlhU2NoZW1hIiwic2NyaXB0dXJlU2NoZW1hIiwiaXQiLCJxdWVyeSIsInJvb3RWYWx1ZSIsInJlc3VsdCIsImV4cGVjdCIsInRvTWF0Y2hTbmFwc2hvdCIsIkNvbnRlbnRJdGVtc0Nvbm5lY3Rpb24iLCJDb250ZW50SXRlbVJlc29sdmVyIiwicmVzb2x2ZXIiLCJpdGVtIiwiY29udGVudCIsInN1bW1hcnkiLCJ0b0VxdWFsIiwiZWRnZXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsImN1cnNvciIsInN0YXJ0Q3Vyc29yIiwiZW5kQ3Vyc29yIiwicGFnZUluZm8iXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FB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c0JBQXNCLENBQUNhLFFBQXZCLENBQWdDO0FBQ3ZFTixNQUFBQTtBQUR1RSxLQUFoQyxDQUF6QztBQUlBVCxJQUFBQSxNQUFNLENBQUNhLFdBQUQsQ0FBTixDQUFvQkwsT0FBcEIsQ0FBNEIsSUFBNUI7QUFDQVIsSUFBQUEsTUFBTSxDQUFDYyxTQUFELENBQU4sQ0FBa0JOLE9BQWxCLENBQTBCLElBQTFCO0FBQ0QsR0FSQyxDQUFGO0FBU0QsQ0F2Qk8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdyYXBocWwgfSBmcm9tICdncmFwaHFsJztcbmltcG9ydCB7IGZldGNoIH0gZnJvbSAnYXBvbGxvLXNlcnZlci1lbnYnO1xuXG5pbXBvcnQgeyBjcmVhdGVHbG9iYWxJZCB9IGZyb20gJ0BhcG9sbG9zcHJvamVjdC9zZXJ2ZXItY29yZSc7XG5pbXBvcnQgeyBjcmVhdGVUZXN0SGVscGVycyB9IGZyb20gJ0BhcG9sbG9zcHJvamVjdC9zZXJ2ZXItY29yZS9saWIvdGVzdFV0aWxzJztcbmltcG9ydCBBcG9sbG9zQ29uZmlnIGZyb20gJ0BhcG9sbG9zcHJvamVjdC9jb25maWcnO1xuXG5pbXBvcnQge1xuICBtZWRpYVNjaGVtYSxcbiAgdGhlbWVTY2hlbWEsXG4gIHNjcmlwdHVyZVNjaGVtYSxcbn0gZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L2RhdGEtc2NoZW1hJztcblxuLy8gd2UgaW1wb3J0IHRoZSByb290LWxldmVsIHNjaGVtYSBhbmQgcmVzb2x2ZXIgc28gd2UgdGVzdCB0aGUgZW50aXJlIGludGVncmF0aW9uOlxuaW1wb3J0IHsgQ29udGVudENoYW5uZWwsIENvbnRlbnRJdGVtLCBTaGFyYWJsZSB9IGZyb20gJy4uLy4uJztcblxuY2xhc3MgU2NyaXB0dXJlIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgaW5pdGlhbGl6ZSgpIHt9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgZ2V0U2NyaXB0dXJlcygpIHtcbiAgICByZXR1cm4gW1xuICAgICAge1xuICAgICAgICBodG1sOiBgPHAgY2xhc3M9XCJwXCI+PHNwYW4gZGF0YS1udW1iZXI9XCIxXCIgY2xhc3M9XCJ2XCI+MTwvc3Bhbj5UaGUgU29uZyBvZiBzb25ncywgd2hpY2ggaXMgU29sb21vbuKAmXMuPC9wPmAsXG4gICAgICB9LFxuICAgIF07XG4gIH1cbn1cblxuY29uc3QgeyBnZXRTY2hlbWEsIGdldENvbnRleHQgfSA9IGNyZWF0ZVRlc3RIZWxwZXJzKHtcbiAgQ29udGVudENoYW5uZWwsXG4gIENvbnRlbnRJdGVtLFxuICBTaGFyYWJsZSxcbiAgVW5pdmVyc2FsQ29udGVudEl0ZW06IHtcbiAgICBkYXRhU291cmNlOiBDb250ZW50SXRlbS5kYXRhU291cmNlLFxuICB9LCAvLyBhbGlhc1xuICBEZXZvdGlvbmFsQ29udGVudEl0ZW06IHtcbiAgICBkYXRhU291cmNlOiBDb250ZW50SXRlbS5kYXRhU291cmNlLFxuICB9LCAvLyBhbGlhc1xuICBTY3JpcHR1cmU6IHtcbiAgICBkYXRhU291cmNlOiBTY3JpcHR1cmUsXG4gIH0sXG59KTtcbi8vIHdlIGltcG9ydCB0aGUgcm9vdC1sZXZlbCBzY2hlbWEgYW5kIHJlc29sdmVyIHNvIHdlIHRlc3QgdGhlIGVudGlyZSBpbnRlZ3JhdGlvbjpcblxuQXBvbGxvc0NvbmZpZy5sb2FkSnMoe1xuICBST0NLOiB7XG4gICAgQVBJX1VSTDogJ2h0dHBzOi8vYXBvbGxvc3JvY2submV3c3ByaW5nLmNjL2FwaScsXG4gICAgQVBJX1RPS0VOOiAnc29tZS1yb2NrLXRva2VuJyxcbiAgICBJTUFHRV9VUkw6ICdodHRwczovL2Fwb2xsb3Nyb2NrLm5ld3NwcmluZy5jYy9HZXRJbWFnZS5hc2h4JyxcbiAgfSxcbiAgUk9DS19DT05TVEFOVFM6IHtcbiAgICBJTUFHRTogMTAsXG4gICAgQVVESU9fRklMRTogNzcsXG4gICAgVklERU9fRklMRTogNzksXG4gIH0sXG4gIFJPQ0tfTUFQUElOR1M6IHtcbiAgICBGRUVEX0NPTlRFTlRfQ0hBTk5FTF9JRFM6IFsxLCAyLCAzLCA0LCA2LCA4XSxcbiAgICBTRVJJRVNfQ09OVEVOVF9DSEFOTkVMX1RZUEVfSURTOiBbNiwgN10sXG4gIH0sXG59KTtcblxuY29uc3QgY29udGVudEl0ZW1GcmFnbWVudCA9IGBcbiAgZnJhZ21lbnQgQ29udGVudEl0ZW1GcmFnbWVudCBvbiBDb250ZW50SXRlbSB7XG4gICAgaWRcbiAgICBfX3R5cGVuYW1lXG4gICAgdGl0bGVcbiAgICBzdW1tYXJ5XG4gICAgY292ZXJJbWFnZSB7XG4gICAgICBuYW1lXG4gICAgICBrZXlcbiAgICAgIHNvdXJjZXMge1xuICAgICAgICB1cmlcbiAgICAgIH1cbiAgICB9XG4gICAgaW1hZ2VzIHtcbiAgICAgIF9fdHlwZW5hbWUgIyBUeXBlbmFtZXMgaGVyZSB0byBpbmNyZWFzZSB0ZXN0IGNvdmVyYWdlXG4gICAgICBuYW1lXG4gICAgICBrZXlcbiAgICAgIHNvdXJjZXMge1xuICAgICAgICBfX3R5cGVuYW1lXG4gICAgICAgIHVyaVxuICAgICAgfVxuICAgIH1cbiAgICB2aWRlb3Mge1xuICAgICAgX190eXBlbmFtZVxuICAgICAgbmFtZVxuICAgICAga2V5XG4gICAgICBzb3VyY2VzIHtcbiAgICAgICAgX190eXBlbmFtZVxuICAgICAgICB1cmlcbiAgICAgIH1cbiAgICAgIGVtYmVkSHRtbFxuICAgIH1cbiAgICBhdWRpb3Mge1xuICAgICAgX190eXBlbmFtZVxuICAgICAgbmFtZVxuICAgICAga2V5XG4gICAgICBzb3VyY2VzIHtcbiAgICAgICAgX190eXBlbmFtZVxuICAgICAgICB1cmlcbiAgICAgIH1cbiAgICB9XG4gICAgaHRtbENvbnRlbnRcbiAgICBjaGlsZENvbnRlbnRJdGVtc0Nvbm5lY3Rpb24ge1xuICAgICAgZWRnZXMge1xuICAgICAgICBub2RlIHtcbiAgICAgICAgICBpZFxuICAgICAgICAgIF9fdHlwZW5hbWVcbiAgICAgICAgfVxuICAgICAgICBjdXJzb3JcbiAgICAgIH1cbiAgICAgIHBhZ2VJbmZvIHtcbiAgICAgICAgc3RhcnRDdXJzb3JcbiAgICAgICAgZW5kQ3Vyc29yXG4gICAgICB9XG4gICAgfVxuICAgIHBhcmVudENoYW5uZWwge1xuICAgICAgaWRcbiAgICAgIF9fdHlwZW5hbWVcbiAgICB9XG4gICAgc2hhcmluZyB7XG4gICAgICBfX3R5cGVuYW1lXG4gICAgICB1cmxcbiAgICAgIHRpdGxlXG4gICAgICBtZXNzYWdlXG4gICAgfVxuICB9XG5gO1xuXG5kZXNjcmliZSgnVW5pdmVyc2FsQ29udGVudEl0ZW0nLCAoKSA9PiB7XG4gIGxldCBzY2hlbWE7XG4gIGxldCBjb250ZXh0O1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBmZXRjaC5yZXNldE1vY2tzKCk7XG4gICAgZmV0Y2gubW9ja1JvY2tEYXRhU291cmNlQVBJKCk7XG4gICAgc2NoZW1hID0gZ2V0U2NoZW1hKFt0aGVtZVNjaGVtYSwgbWVkaWFTY2hlbWEsIHNjcmlwdHVyZVNjaGVtYV0pO1xuICAgIGNvbnRleHQgPSBnZXRDb250ZXh0KCk7XG4gIH0pO1xuXG4gIGl0KCdnZXRzIGEgdXNlciBmZWVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgcXVlcnkge1xuICAgICAgICB1c2VyRmVlZCB7XG4gICAgICAgICAgZWRnZXMge1xuICAgICAgICAgICAgbm9kZSB7XG4gICAgICAgICAgICAgIC4uLkNvbnRlbnRJdGVtRnJhZ21lbnRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgICR7Y29udGVudEl0ZW1GcmFnbWVudH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoJ2dldHMgYSBjb250ZW50IGl0ZW0nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcXVlcnkgPSBgXG4gICAgICBxdWVyeSB7XG4gICAgICAgIG5vZGUoaWQ6IFwiJHtjcmVhdGVHbG9iYWxJZCgxLCAnVW5pdmVyc2FsQ29udGVudEl0ZW0nKX1cIikge1xuICAgICAgICAgIC4uLkNvbnRlbnRJdGVtRnJhZ21lbnRcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgJHtjb250ZW50SXRlbUZyYWdtZW50fVxuICAgIGA7XG4gICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHQpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcblxuICBpdCgnZ2V0cyBhIE1lZGlhQ29udGVudEl0ZW0gaXRlbScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgbm9kZShpZDogXCIke2NyZWF0ZUdsb2JhbElkKDEsICdNZWRpYUNvbnRlbnRJdGVtJyl9XCIpIHtcbiAgICAgICAgICAuLi5Db250ZW50SXRlbUZyYWdtZW50XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgICR7Y29udGVudEl0ZW1GcmFnbWVudH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoJ2dldHMgYSBDb250ZW50U2VyaWVzQ29udGVudEl0ZW0gaXRlbScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgbm9kZShpZDogXCIke2NyZWF0ZUdsb2JhbElkKDEsICdDb250ZW50U2VyaWVzQ29udGVudEl0ZW0nKX1cIikge1xuICAgICAgICAgIC4uLkNvbnRlbnRJdGVtRnJhZ21lbnRcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgJHtjb250ZW50SXRlbUZyYWdtZW50fVxuICAgIGA7XG4gICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHQpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcblxuICBpdCgnZ2V0cyBhIGRldm90aW9uYWwgaXRlbScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgbm9kZShpZDogXCIke2NyZWF0ZUdsb2JhbElkKDEyMywgJ0Rldm90aW9uYWxDb250ZW50SXRlbScpfVwiKSB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICAuLi4gb24gRGV2b3Rpb25hbENvbnRlbnRJdGVtIHtcbiAgICAgICAgICAgIGlkXG4gICAgICAgICAgICB0aXRsZVxuICAgICAgICAgICAgc2NyaXB0dXJlcyB7XG4gICAgICAgICAgICAgIGh0bWxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoXCJnZXRzIGEgY29udGVudCBpdGVtIGFuZCBpdCdzIHNpYmxpbmdzXCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgdXNlckZlZWQge1xuICAgICAgICAgIGVkZ2VzIHtcbiAgICAgICAgICAgIG5vZGUge1xuICAgICAgICAgICAgICAuLi5Db250ZW50SXRlbUZyYWdtZW50XG4gICAgICAgICAgICAgIC4uLiBvbiBVbml2ZXJzYWxDb250ZW50SXRlbSB7XG4gICAgICAgICAgICAgICAgc2libGluZ0NvbnRlbnRJdGVtc0Nvbm5lY3Rpb24ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRnZXMge1xuICAgICAgICAgICAgICAgICAgICBub2RlIHtcbiAgICAgICAgICAgICAgICAgICAgICBpZFxuICAgICAgICAgICAgICAgICAgICAgIF9fdHlwZW5hbWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjdXJzb3JcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgICR7Y29udGVudEl0ZW1GcmFnbWVudH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoJ3Byb3Blcmx5IGhhbmRsZXMgZW1wdHkgYXR0cmlidXRlIHZhbHVlcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgbm9kZShpZDogXCIke2NyZWF0ZUdsb2JhbElkKFxuICAgICAgICAgICd0ZXN0LWNhc2Utbm8tYXR0cmlidXRlcycsXG4gICAgICAgICAgJ1VuaXZlcnNhbENvbnRlbnRJdGVtJ1xuICAgICAgICApfVwiKSB7XG4gICAgICAgICAgLi4uQ29udGVudEl0ZW1GcmFnbWVudFxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAke2NvbnRlbnRJdGVtRnJhZ21lbnR9XG4gICAgYDtcbiAgICBjb25zdCByb290VmFsdWUgPSB7fTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBncmFwaHFsKHNjaGVtYSwgcXVlcnksIHJvb3RWYWx1ZSwgY29udGV4dCk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xufSk7XG5cbmNvbnN0IHtcbiAgQ29udGVudEl0ZW1zQ29ubmVjdGlvbixcbiAgQ29udGVudEl0ZW06IENvbnRlbnRJdGVtUmVzb2x2ZXIsXG59ID0gQ29udGVudEl0ZW0ucmVzb2x2ZXI7XG5cbmRlc2NyaWJlKCdDb250ZW50SXRlbSByZXNvbHZlcicsICgpID0+IHtcbiAgaXQoJ2ZldGNoZXMgYW4gaXRlbSBzdW1tYXJ5IGZvciBhbiBpdGVtIHdpdGggbm8gZGVzY3JpcHRpb24nLCAoKSA9PiB7XG4gICAgY29uc3QgaXRlbSA9IHsgY29udGVudDogJycgfTtcbiAgICBjb25zdCBzdW1tYXJ5ID0gQ29udGVudEl0ZW1SZXNvbHZlci5zdW1tYXJ5KGl0ZW0pO1xuICAgIGV4cGVjdChzdW1tYXJ5KS50b0VxdWFsKCcnKTtcbiAgfSk7XG4gIGl0KCdmZXRjaGVzIGFuIGl0ZW0gc3VtbWFyeSBmb3IgYW4gaXRlbSB3aXRoIGEgZGVzY3JpcHRpb24nLCAoKSA9PiB7XG4gICAgY29uc3QgaXRlbSA9IHsgY29udGVudDogJ0ZvbyBiYXIgYmF6LiBTb21lIG90aGVyIGZvby4nIH07XG4gICAgY29uc3Qgc3VtbWFyeSA9IENvbnRlbnRJdGVtUmVzb2x2ZXIuc3VtbWFyeShpdGVtKTtcbiAgICBleHBlY3Qoc3VtbWFyeSkudG9FcXVhbCgnRm9vIGJhciBiYXouJyk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdDb250ZW50SXRlbXNDb25uZWN0aW9uIHJlc29sdmVyJywgKCkgPT4ge1xuICBpdCgnYnVpbGRzIGEgcGFnZUluZm8gb2JqZWN0IHdpdGggaXRlbXMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZWRnZXMgPSBQcm9taXNlLnJlc29sdmUoW1xuICAgICAgeyBjdXJzb3I6IGBpdGVtLTBgIH0sXG4gICAgICB7IGN1cnNvcjogYGl0ZW0tMWAgfSxcbiAgICAgIHsgY3Vyc29yOiBgaXRlbS0yYCB9LFxuICAgIF0pO1xuICAgIGNvbnN0IHsgc3RhcnRDdXJzb3IsIGVuZEN1cnNvciB9ID0gYXdhaXQgQ29udGVudEl0ZW1zQ29ubmVjdGlvbi5wYWdlSW5mbyh7XG4gICAgICBlZGdlcyxcbiAgICB9KTtcblxuICAgIGV4cGVjdChzdGFydEN1cnNvcikudG9FcXVhbCgnaXRlbS0wJyk7XG4gICAgZXhwZWN0KGVuZEN1cnNvcikudG9FcXVhbCgnaXRlbS0yJyk7XG4gIH0pO1xuICBpdCgnYnVpbGRzIGEgcGFnZUluZm8gb2JqZWN0IHdpdGhvdXQgaXRlbXMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZWRnZXMgPSBbXTtcbiAgICBjb25zdCB7IHN0YXJ0Q3Vyc29yLCBlbmRDdXJzb3IgfSA9IGF3YWl0IENvbnRlbnRJdGVtc0Nvbm5lY3Rpb24ucGFnZUluZm8oe1xuICAgICAgZWRnZXMsXG4gICAgfSk7XG5cbiAgICBleHBlY3Qoc3RhcnRDdXJzb3IpLnRvRXF1YWwobnVsbCk7XG4gICAgZXhwZWN0KGVuZEN1cnNvcikudG9FcXVhbChudWxsKTtcbiAgfSk7XG59KTtcbiJdfQ==