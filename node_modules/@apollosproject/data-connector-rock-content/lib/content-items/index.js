"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "dataSource", {
  enumerable: true,
  get: function () {
    return _dataSource.default;
  }
});
Object.defineProperty(exports, "schema", {
  enumerable: true,
  get: function () {
    return _dataSchema.contentItemSchema;
  }
});
exports.resolver = exports.defaultContentItemResolvers = void 0;

var _lodash = require("lodash");

var _natural = _interopRequireDefault(require("natural"));

var _sanitizeHtml = _interopRequireDefault(require("sanitize-html"));

var _serverCore = require("@apollosproject/server-core");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _sanitizeHtml2 = _interopRequireDefault(require("../sanitize-html"));

var _dataSource = _interopRequireDefault(require("./data-source"));

var _dataSchema = require("@apollosproject/data-schema");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  ROCK_CONSTANTS,
  ROCK_MAPPINGS,
  ROCK
} = _config.default;

const enforceProtocol = uri => uri.startsWith('//') ? `https:${uri}` : uri;

const createImageUrl = uri => uri.split('-').length === 5 ? `${ROCK.IMAGE_URL}?guid=${uri}` : enforceProtocol(uri); // export { default as model } from './model';


// Empty fields in rock default to `''`
const hasScripture = ({
  attributeValues
}) => (0, _lodash.get)(attributeValues, 'scriptures.value', '') !== '';

const isImage = ({
  key,
  attributeValues,
  attributes
}) => attributes[key].fieldTypeId === ROCK_CONSTANTS.IMAGE || key.toLowerCase().includes('image') && typeof attributeValues[key].value === 'string' && attributeValues[key].value.startsWith('http'); // looks like an image url


const isVideo = ({
  key,
  attributeValues,
  attributes
}) => attributes[key].fieldTypeId === ROCK_CONSTANTS.VIDEO_FILE || attributes[key].fieldTypeId === ROCK_CONSTANTS.VIDEO_URL || key.toLowerCase().includes('video') && typeof attributeValues[key].value === 'string' && attributeValues[key].value.startsWith('http'); // looks like a video url


const isAudio = ({
  key,
  attributeValues,
  attributes
}) => attributes[key].fieldTypeId === ROCK_CONSTANTS.AUDIO_FILE || attributes[key].fieldTypeId === ROCK_CONSTANTS.AUDIO_URL || key.toLowerCase().includes('audio') && typeof attributeValues[key].value === 'string' && attributeValues[key].value.startsWith('http'); // looks like an audio url


const hasMedia = ({
  attributeValues,
  attributes
}) => Object.keys(attributes).filter(key => isVideo({
  key,
  attributeValues,
  attributes
})).length || Object.keys(attributes).filter(key => isAudio({
  key,
  attributeValues,
  attributes
})).length;

const defaultContentItemResolvers = {
  id: ({
    id
  }, args, context, {
    parentType
  }) => (0, _serverCore.createGlobalId)(id, parentType.name),
  htmlContent: ({
    content
  }) => (0, _sanitizeHtml2.default)(content),
  childContentItemsConnection: async ({
    id
  }, args, {
    dataSources
  }) => dataSources.ContentItem.paginate({
    cursor: await dataSources.ContentItem.getCursorByParentContentItemId(id),
    args
  }),
  parentChannel: ({
    contentChannelId
  }, args, {
    dataSources
  }) => dataSources.ContentChannel.getFromId(contentChannelId),
  siblingContentItemsConnection: async ({
    id
  }, args, {
    dataSources
  }) => dataSources.ContentItem.paginate({
    cursor: await dataSources.ContentItem.getCursorBySiblingContentItemId(id),
    args
  }),
  summary: ({
    summary,
    content
  }) => {
    if (summary) return summary;
    if (content == null) return ''; // Protect against 0 length sentences (tokenizer will throw an error)

    if (content.split(' ').length === 1) return '';
    const tokenizer = new _natural.default.SentenceTokenizer();
    return tokenizer.tokenize((0, _sanitizeHtml.default)(content, {
      allowedTags: [],
      allowedAttributes: []
    }))[0];
  },
  images: ({
    attributeValues,
    attributes
  }) => {
    const imageKeys = Object.keys(attributes).filter(key => isImage({
      key,
      attributeValues,
      attributes
    }));
    return imageKeys.map(key => ({
      __typename: 'ImageMedia',
      key,
      name: attributes[key].name,
      sources: attributeValues[key].value ? [{
        uri: createImageUrl(attributeValues[key].value)
      }] : []
    }));
  },
  videos: ({
    attributeValues,
    attributes
  }) => {
    const videoKeys = Object.keys(attributes).filter(key => isVideo({
      key,
      attributeValues,
      attributes
    }));
    return videoKeys.map(key => ({
      __typename: 'VideoMedia',
      key,
      name: attributes[key].name,
      embedHtml: (0, _lodash.get)(attributeValues, 'videoEmbed.value', null),
      // TODO: this assumes that the key `VideoEmebed` is always used on Rock
      sources: attributeValues[key].value ? [{
        uri: attributeValues[key].value
      }] : []
    }));
  },
  audios: ({
    attributeValues,
    attributes
  }) => {
    const audioKeys = Object.keys(attributes).filter(key => isAudio({
      key,
      attributeValues,
      attributes
    }));
    return audioKeys.map(key => ({
      __typename: 'AudioMedia',
      key,
      name: attributes[key].name,
      sources: attributeValues[key].value ? [{
        uri: attributeValues[key].value
      }] : []
    }));
  },
  coverImage: async (root, args, {
    dataSources
  }) => {
    const pickBestImage = images => {
      // TODO: there's probably a _much_ more explicit and better way to handle this
      const squareImage = images.find(image => image.key.toLowerCase().includes('square'));
      if (squareImage) return { ...squareImage,
        __typename: 'ImageMedia'
      };
      return { ...images[0],
        __typename: 'ImageMedia'
      };
    };

    let defaultImages = defaultContentItemResolvers.images(root) || [];
    defaultImages = defaultImages.filter(image => image.sources.length); // filter images w/o URLs

    if (defaultImages.length) return pickBestImage(defaultImages); // If no image, check parent for image:

    const parentItemsCursor = await dataSources.ContentItem.getCursorByChildContentItemId(root.id);
    if (!parentItemsCursor) return null;
    const parentItems = await parentItemsCursor.get();

    if (parentItems.length) {
      const parentImages = parentItems.map(defaultContentItemResolvers.images).find(images => images.length).filter(image => image.sources.length); // filter images w/o URLs

      if (parentImages && parentImages.length) return pickBestImage(parentImages);
    }

    return null;
  },
  theme: () => null,
  // todo: integrate themes from Rock
  sharing: root => ({
    __type: 'SharableContentItem',
    ...root
  })
};
exports.defaultContentItemResolvers = defaultContentItemResolvers;
const resolver = {
  Query: {
    userFeed: (root, args, {
      dataSources
    }) => dataSources.ContentItem.paginate({
      cursor: dataSources.ContentItem.byUserFeed(),
      args
    })
  },
  DevotionalContentItem: { ...defaultContentItemResolvers,
    scriptures: ({
      attributeValues
    }, args, {
      dataSources
    }) => {
      const reference = (0, _lodash.get)(attributeValues, 'scriptures.value');

      if (reference && reference != null) {
        return dataSources.Scripture.getScriptures(reference);
      }

      return null;
    }
  },
  UniversalContentItem: { ...defaultContentItemResolvers
  },
  ContentSeriesContentItem: { ...defaultContentItemResolvers
  },
  MediaContentItem: { ...defaultContentItemResolvers
  },
  ContentItem: { ...defaultContentItemResolvers,
    __resolveType: async ({
      attributeValues,
      attributes,
      contentChannelTypeId
    }) => {
      if (hasScripture({
        attributeValues
      }) && ROCK_MAPPINGS.DEVOTIONAL_TYPE_IDS.includes(contentChannelTypeId)) {
        return 'DevotionalContentItem';
      }

      if (ROCK_MAPPINGS.SERIES_CONTENT_CHANNEL_TYPE_IDS.includes(contentChannelTypeId)) {
        return 'ContentSeriesContentItem';
      }

      if (hasMedia({
        attributeValues,
        attributes
      })) {
        return 'MediaContentItem';
      }

      return 'UniversalContentItem';
    }
  },
  SharableContentItem: {
    url: () => 'https://apollosrock.newspring.cc/',
    // todo: return a dynamic url that links to the content item
    title: ({
      title
    }) => title,
    message: () => ''
  },
  ContentItemsConnection: {
    pageInfo: _serverCore.withEdgePagination
  }
};
exports.resolver = resolver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250ZW50LWl0ZW1zL2luZGV4LmpzIl0sIm5hbWVzIjpbIlJPQ0tfQ09OU1RBTlRTIiwiUk9DS19NQVBQSU5HUyIsIlJPQ0siLCJBcG9sbG9zQ29uZmlnIiwiZW5mb3JjZVByb3RvY29sIiwidXJpIiwic3RhcnRzV2l0aCIsImNyZWF0ZUltYWdlVXJsIiwic3BsaXQiLCJsZW5ndGgiLCJJTUFHRV9VUkwiLCJoYXNTY3JpcHR1cmUiLCJhdHRyaWJ1dGVWYWx1ZXMiLCJpc0ltYWdlIiwia2V5IiwiYXR0cmlidXRlcyIsImZpZWxkVHlwZUlkIiwiSU1BR0UiLCJ0b0xvd2VyQ2FzZSIsImluY2x1ZGVzIiwidmFsdWUiLCJpc1ZpZGVvIiwiVklERU9fRklMRSIsIlZJREVPX1VSTCIsImlzQXVkaW8iLCJBVURJT19GSUxFIiwiQVVESU9fVVJMIiwiaGFzTWVkaWEiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiZGVmYXVsdENvbnRlbnRJdGVtUmVzb2x2ZXJzIiwiaWQiLCJhcmdzIiwiY29udGV4dCIsInBhcmVudFR5cGUiLCJuYW1lIiwiaHRtbENvbnRlbnQiLCJjb250ZW50IiwiY2hpbGRDb250ZW50SXRlbXNDb25uZWN0aW9uIiwiZGF0YVNvdXJjZXMiLCJDb250ZW50SXRlbSIsInBhZ2luYXRlIiwiY3Vyc29yIiwiZ2V0Q3Vyc29yQnlQYXJlbnRDb250ZW50SXRlbUlkIiwicGFyZW50Q2hhbm5lbCIsImNvbnRlbnRDaGFubmVsSWQiLCJDb250ZW50Q2hhbm5lbCIsImdldEZyb21JZCIsInNpYmxpbmdDb250ZW50SXRlbXNDb25uZWN0aW9uIiwiZ2V0Q3Vyc29yQnlTaWJsaW5nQ29udGVudEl0ZW1JZCIsInN1bW1hcnkiLCJ0b2tlbml6ZXIiLCJuYXR1cmFsIiwiU2VudGVuY2VUb2tlbml6ZXIiLCJ0b2tlbml6ZSIsImFsbG93ZWRUYWdzIiwiYWxsb3dlZEF0dHJpYnV0ZXMiLCJpbWFnZXMiLCJpbWFnZUtleXMiLCJtYXAiLCJfX3R5cGVuYW1lIiwic291cmNlcyIsInZpZGVvcyIsInZpZGVvS2V5cyIsImVtYmVkSHRtbCIsImF1ZGlvcyIsImF1ZGlvS2V5cyIsImNvdmVySW1hZ2UiLCJyb290IiwicGlja0Jlc3RJbWFnZSIsInNxdWFyZUltYWdlIiwiZmluZCIsImltYWdlIiwiZGVmYXVsdEltYWdlcyIsInBhcmVudEl0ZW1zQ3Vyc29yIiwiZ2V0Q3Vyc29yQnlDaGlsZENvbnRlbnRJdGVtSWQiLCJwYXJlbnRJdGVtcyIsImdldCIsInBhcmVudEltYWdlcyIsInRoZW1lIiwic2hhcmluZyIsIl9fdHlwZSIsInJlc29sdmVyIiwiUXVlcnkiLCJ1c2VyRmVlZCIsImJ5VXNlckZlZWQiLCJEZXZvdGlvbmFsQ29udGVudEl0ZW0iLCJzY3JpcHR1cmVzIiwicmVmZXJlbmNlIiwiU2NyaXB0dXJlIiwiZ2V0U2NyaXB0dXJlcyIsIlVuaXZlcnNhbENvbnRlbnRJdGVtIiwiQ29udGVudFNlcmllc0NvbnRlbnRJdGVtIiwiTWVkaWFDb250ZW50SXRlbSIsIl9fcmVzb2x2ZVR5cGUiLCJjb250ZW50Q2hhbm5lbFR5cGVJZCIsIkRFVk9USU9OQUxfVFlQRV9JRFMiLCJTRVJJRVNfQ09OVEVOVF9DSEFOTkVMX1RZUEVfSURTIiwiU2hhcmFibGVDb250ZW50SXRlbSIsInVybCIsInRpdGxlIiwibWVzc2FnZSIsIkNvbnRlbnRJdGVtc0Nvbm5lY3Rpb24iLCJwYWdlSW5mbyIsIndpdGhFZGdlUGFnaW5hdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQVlBOztBQUNBOzs7O0FBWEEsTUFBTTtBQUFFQSxFQUFBQSxjQUFGO0FBQWtCQyxFQUFBQSxhQUFsQjtBQUFpQ0MsRUFBQUE7QUFBakMsSUFBMENDLGVBQWhEOztBQUVBLE1BQU1DLGVBQWUsR0FBSUMsR0FBRCxJQUFVQSxHQUFHLENBQUNDLFVBQUosQ0FBZSxJQUFmLElBQXdCLFNBQVFELEdBQUksRUFBcEMsR0FBd0NB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Q0FBa0M5RSxRQUFsQyxDQUEyQzZFLG9CQUEzQyxDQUZGLEVBR0U7QUFDQSxlQUFPLHVCQUFQO0FBQ0Q7O0FBRUQsVUFDRS9GLGFBQWEsQ0FBQ2lHLCtCQUFkLENBQThDL0UsUUFBOUMsQ0FDRTZFLG9CQURGLENBREYsRUFJRTtBQUNBLGVBQU8sMEJBQVA7QUFDRDs7QUFFRCxVQUFJckUsUUFBUSxDQUFDO0FBQUVmLFFBQUFBLGVBQUY7QUFBbUJHLFFBQUFBO0FBQW5CLE9BQUQsQ0FBWixFQUErQztBQUM3QyxlQUFPLGtCQUFQO0FBQ0Q7O0FBRUQsYUFBTyxzQkFBUDtBQUNEO0FBM0JVLEdBM0JTO0FBd0R0Qm9GLEVBQUFBLG1CQUFtQixFQUFFO0FBQ25CQyxJQUFBQSxHQUFHLEVBQUUsTUFBTSxtQ0FEUTtBQUM2QjtBQUNoREMsSUFBQUEsS0FBSyxFQUFFLENBQUM7QUFBRUEsTUFBQUE7QUFBRixLQUFELEtBQWVBLEtBRkg7QUFHbkJDLElBQUFBLE9BQU8sRUFBRSxNQUFNO0FBSEksR0F4REM7QUE2RHRCQyxFQUFBQSxzQkFBc0IsRUFBRTtBQUN0QkMsSUFBQUEsUUFBUSxFQUFFQztBQURZO0FBN0RGLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBuYXR1cmFsIGZyb20gJ25hdHVyYWwnO1xuaW1wb3J0IHNhbml0aXplSHRtbE5vZGUgZnJvbSAnc2FuaXRpemUtaHRtbCc7XG5pbXBvcnQge1xuICBjcmVhdGVHbG9iYWxJZCxcbiAgd2l0aEVkZ2VQYWdpbmF0aW9uLFxufSBmcm9tICdAYXBvbGxvc3Byb2plY3Qvc2VydmVyLWNvcmUnO1xuaW1wb3J0IEFwb2xsb3NDb25maWcgZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L2NvbmZpZyc7XG5pbXBvcnQgc2FuaXRpemVIdG1sIGZyb20gJy4uL3Nhbml0aXplLWh0bWwnO1xuXG5jb25zdCB7IFJPQ0tfQ09OU1RBTlRTLCBST0NLX01BUFBJTkdTLCBST0NLIH0gPSBBcG9sbG9zQ29uZmlnO1xuXG5jb25zdCBlbmZvcmNlUHJvdG9jb2wgPSAodXJpKSA9PiAodXJpLnN0YXJ0c1dpdGgoJy8vJykgPyBgaHR0cHM6JHt1cml9YCA6IHVyaSk7XG5cbmNvbnN0IGNyZWF0ZUltYWdlVXJsID0gKHVyaSkgPT5cbiAgdXJpLnNwbGl0KCctJykubGVuZ3RoID09PSA1XG4gICAgPyBgJHtST0NLLklNQUdFX1VSTH0/Z3VpZD0ke3VyaX1gXG4gICAgOiBlbmZvcmNlUHJvdG9jb2wodXJpKTtcblxuLy8gZXhwb3J0IHsgZGVmYXVsdCBhcyBtb2RlbCB9IGZyb20gJy4vbW9kZWwnO1xuZXhwb3J0IHsgZGVmYXVsdCBhcyBkYXRhU291cmNlIH0gZnJvbSAnLi9kYXRhLXNvdXJjZSc7XG5leHBvcnQgeyBjb250ZW50SXRlbVNjaGVtYSBhcyBzY2hlbWEgfSBmcm9tICdAYXBvbGxvc3Byb2plY3QvZGF0YS1zY2hlbWEnO1xuXG4vLyBFbXB0eSBmaWVsZHMgaW4gcm9jayBkZWZhdWx0IHRvIGAnJ2BcbmNvbnN0IGhhc1NjcmlwdHVyZSA9ICh7IGF0dHJpYnV0ZVZhbHVlcyB9KSA9PlxuICBnZXQoYXR0cmlidXRlVmFsdWVzLCAnc2NyaXB0dXJlcy52YWx1ZScsICcnKSAhPT0gJyc7XG5cbmNvbnN0IGlzSW1hZ2UgPSAoeyBrZXksIGF0dHJpYnV0ZVZhbHVlcywgYXR0cmlidXRlcyB9KSA9PlxuICBhdHRyaWJ1dGVzW2tleV0uZmllbGRUeXBlSWQgPT09IFJPQ0tfQ09OU1RBTlRTLklNQUdFIHx8XG4gIChrZXkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaW1hZ2UnKSAmJlxuICAgIHR5cGVvZiBhdHRyaWJ1dGVWYWx1ZXNba2V5XS52YWx1ZSA9PT0gJ3N0cmluZycgJiZcbiAgICBhdHRyaWJ1dGVWYWx1ZXNba2V5XS52YWx1ZS5zdGFydHNXaXRoKCdodHRwJykpOyAvLyBsb29rcyBsaWtlIGFuIGltYWdlIHVybFxuXG5jb25zdCBpc1ZpZGVvID0gKHsga2V5LCBhdHRyaWJ1dGVWYWx1ZXMsIGF0dHJpYnV0ZXMgfSkgPT5cbiAgYXR0cmlidXRlc1trZXldLmZpZWxkVHlwZUlkID09PSBST0NLX0NPTlNUQU5UUy5WSURFT19GSUxFIHx8XG4gIGF0dHJpYnV0ZXNba2V5XS5maWVsZFR5cGVJZCA9PT0gUk9DS19DT05TVEFOVFMuVklERU9fVVJMIHx8XG4gIChrZXkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygndmlkZW8nKSAmJlxuICAgIHR5cGVvZiBhdHRyaWJ1dGVWYWx1ZXNba2V5XS52YWx1ZSA9PT0gJ3N0cmluZycgJiZcbiAgICBhdHRyaWJ1dGVWYWx1ZXNba2V5XS52YWx1ZS5zdGFydHNXaXRoKCdodHRwJykpOyAvLyBsb29rcyBsaWtlIGEgdmlkZW8gdXJsXG5cbmNvbnN0IGlzQXVkaW8gPSAoeyBrZXksIGF0dHJpYnV0ZVZhbHVlcywgYXR0cmlidXRlcyB9KSA9PlxuICBhdHRyaWJ1dGVzW2tleV0uZmllbGRUeXBlSWQgPT09IFJPQ0tfQ09OU1RBTlRTLkFVRElPX0ZJTEUgfHxcbiAgYXR0cmlidXRlc1trZXldLmZpZWxkVHlwZUlkID09PSBST0NLX0NPTlNUQU5UUy5BVURJT19VUkwgfHxcbiAgKGtleS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdhdWRpbycpICYmXG4gICAgdHlwZW9mIGF0dHJpYnV0ZVZhbHVlc1trZXldLnZhbHVlID09PSAnc3RyaW5nJyAmJlxuICAgIGF0dHJpYnV0ZVZhbHVlc1trZXldLnZhbHVlLnN0YXJ0c1dpdGgoJ2h0dHAnKSk7IC8vIGxvb2tzIGxpa2UgYW4gYXVkaW8gdXJsXG5cbmNvbnN0IGhhc01lZGlhID0gKHsgYXR0cmlidXRlVmFsdWVzLCBhdHRyaWJ1dGVzIH0pID0+XG4gIE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpLmZpbHRlcigoa2V5KSA9PlxuICAgIGlzVmlkZW8oe1xuICAgICAga2V5LFxuICAgICAgYXR0cmlidXRlVmFsdWVzLFxuICAgICAgYXR0cmlidXRlcyxcbiAgICB9KVxuICApLmxlbmd0aCB8fFxuICBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKS5maWx0ZXIoKGtleSkgPT5cbiAgICBpc0F1ZGlvKHtcbiAgICAgIGtleSxcbiAgICAgIGF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIGF0dHJpYnV0ZXMsXG4gICAgfSlcbiAgKS5sZW5ndGg7XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0Q29udGVudEl0ZW1SZXNvbHZlcnMgPSB7XG4gIGlkOiAoeyBpZCB9LCBhcmdzLCBjb250ZXh0LCB7IHBhcmVudFR5cGUgfSkgPT5cbiAgICBjcmVhdGVHbG9iYWxJZChpZCwgcGFyZW50VHlwZS5uYW1lKSxcbiAgaHRtbENvbnRlbnQ6ICh7IGNvbnRlbnQgfSkgPT4gc2FuaXRpemVIdG1sKGNvbnRlbnQpLFxuICBjaGlsZENvbnRlbnRJdGVtc0Nvbm5lY3Rpb246IGFzeW5jICh7IGlkIH0sIGFyZ3MsIHsgZGF0YVNvdXJjZXMgfSkgPT5cbiAgICBkYXRhU291cmNlcy5Db250ZW50SXRlbS5wYWdpbmF0ZSh7XG4gICAgICBjdXJzb3I6IGF3YWl0IGRhdGFTb3VyY2VzLkNvbnRlbnRJdGVtLmdldEN1cnNvckJ5UGFyZW50Q29udGVudEl0ZW1JZChpZCksXG4gICAgICBhcmdzLFxuICAgIH0pLFxuXG4gIHBhcmVudENoYW5uZWw6ICh7IGNvbnRlbnRDaGFubmVsSWQgfSwgYXJncywgeyBkYXRhU291cmNlcyB9KSA9PlxuICAgIGRhdGFTb3VyY2VzLkNvbnRlbnRDaGFubmVsLmdldEZyb21JZChjb250ZW50Q2hhbm5lbElkKSxcblxuICBzaWJsaW5nQ29udGVudEl0ZW1zQ29ubmVjdGlvbjogYXN5bmMgKHsgaWQgfSwgYXJncywgeyBkYXRhU291cmNlcyB9KSA9PlxuICAgIGRhdGFTb3VyY2VzLkNvbnRlbnRJdGVtLnBhZ2luYXRlKHtcbiAgICAgIGN1cnNvcjogYXdhaXQgZGF0YVNvdXJjZXMuQ29udGVudEl0ZW0uZ2V0Q3Vyc29yQnlTaWJsaW5nQ29udGVudEl0ZW1JZChpZCksXG4gICAgICBhcmdzLFxuICAgIH0pLFxuXG4gIHN1bW1hcnk6ICh7IHN1bW1hcnksIGNvbnRlbnQgfSkgPT4ge1xuICAgIGlmIChzdW1tYXJ5KSByZXR1cm4gc3VtbWFyeTtcbiAgICBpZiAoY29udGVudCA9PSBudWxsKSByZXR1cm4gJyc7XG4gICAgLy8gUHJvdGVjdCBhZ2FpbnN0IDAgbGVuZ3RoIHNlbnRlbmNlcyAodG9rZW5pemVyIHdpbGwgdGhyb3cgYW4gZXJyb3IpXG4gICAgaWYgKGNvbnRlbnQuc3BsaXQoJyAnKS5sZW5ndGggPT09IDEpIHJldHVybiAnJztcblxuICAgIGNvbnN0IHRva2VuaXplciA9IG5ldyBuYXR1cmFsLlNlbnRlbmNlVG9rZW5pemVyKCk7XG4gICAgcmV0dXJuIHRva2VuaXplci50b2tlbml6ZShcbiAgICAgIHNhbml0aXplSHRtbE5vZGUoY29udGVudCwge1xuICAgICAgICBhbGxvd2VkVGFnczogW10sXG4gICAgICAgIGFsbG93ZWRBdHRyaWJ1dGVzOiBbXSxcbiAgICAgIH0pXG4gICAgKVswXTtcbiAgfSxcblxuICBpbWFnZXM6ICh7IGF0dHJpYnV0ZVZhbHVlcywgYXR0cmlidXRlcyB9KSA9PiB7XG4gICAgY29uc3QgaW1hZ2VLZXlzID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcykuZmlsdGVyKChrZXkpID0+XG4gICAgICBpc0ltYWdlKHtcbiAgICAgICAga2V5LFxuICAgICAgICBhdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAgIGF0dHJpYnV0ZXMsXG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIGltYWdlS2V5cy5tYXAoKGtleSkgPT4gKHtcbiAgICAgIF9fdHlwZW5hbWU6ICdJbWFnZU1lZGlhJyxcbiAgICAgIGtleSxcbiAgICAgIG5hbWU6IGF0dHJpYnV0ZXNba2V5XS5uYW1lLFxuICAgICAgc291cmNlczogYXR0cmlidXRlVmFsdWVzW2tleV0udmFsdWVcbiAgICAgICAgPyBbeyB1cmk6IGNyZWF0ZUltYWdlVXJsKGF0dHJpYnV0ZVZhbHVlc1trZXldLnZhbHVlKSB9XVxuICAgICAgICA6IFtdLFxuICAgIH0pKTtcbiAgfSxcblxuICB2aWRlb3M6ICh7IGF0dHJpYnV0ZVZhbHVlcywgYXR0cmlidXRlcyB9KSA9PiB7XG4gICAgY29uc3QgdmlkZW9LZXlzID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcykuZmlsdGVyKChrZXkpID0+XG4gICAgICBpc1ZpZGVvKHtcbiAgICAgICAga2V5LFxuICAgICAgICBhdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAgIGF0dHJpYnV0ZXMsXG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHZpZGVvS2V5cy5tYXAoKGtleSkgPT4gKHtcbiAgICAgIF9fdHlwZW5hbWU6ICdWaWRlb01lZGlhJyxcbiAgICAgIGtleSxcbiAgICAgIG5hbWU6IGF0dHJpYnV0ZXNba2V5XS5uYW1lLFxuICAgICAgZW1iZWRIdG1sOiBnZXQoYXR0cmlidXRlVmFsdWVzLCAndmlkZW9FbWJlZC52YWx1ZScsIG51bGwpLCAvLyBUT0RPOiB0aGlzIGFzc3VtZXMgdGhhdCB0aGUga2V5IGBWaWRlb0VtZWJlZGAgaXMgYWx3YXlzIHVzZWQgb24gUm9ja1xuICAgICAgc291cmNlczogYXR0cmlidXRlVmFsdWVzW2tleV0udmFsdWVcbiAgICAgICAgPyBbeyB1cmk6IGF0dHJpYnV0ZVZhbHVlc1trZXldLnZhbHVlIH1dXG4gICAgICAgIDogW10sXG4gICAgfSkpO1xuICB9LFxuXG4gIGF1ZGlvczogKHsgYXR0cmlidXRlVmFsdWVzLCBhdHRyaWJ1dGVzIH0pID0+IHtcbiAgICBjb25zdCBhdWRpb0tleXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKS5maWx0ZXIoKGtleSkgPT5cbiAgICAgIGlzQXVkaW8oe1xuICAgICAgICBrZXksXG4gICAgICAgIGF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgYXR0cmlidXRlcyxcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gYXVkaW9LZXlzLm1hcCgoa2V5KSA9PiAoe1xuICAgICAgX190eXBlbmFtZTogJ0F1ZGlvTWVkaWEnLFxuICAgICAga2V5LFxuICAgICAgbmFtZTogYXR0cmlidXRlc1trZXldLm5hbWUsXG4gICAgICBzb3VyY2VzOiBhdHRyaWJ1dGVWYWx1ZXNba2V5XS52YWx1ZVxuICAgICAgICA/IFt7IHVyaTogYXR0cmlidXRlVmFsdWVzW2tleV0udmFsdWUgfV1cbiAgICAgICAgOiBbXSxcbiAgICB9KSk7XG4gIH0sXG5cbiAgY292ZXJJbWFnZTogYXN5bmMgKHJvb3QsIGFyZ3MsIHsgZGF0YVNvdXJjZXMgfSkgPT4ge1xuICAgIGNvbnN0IHBpY2tCZXN0SW1hZ2UgPSAoaW1hZ2VzKSA9PiB7XG4gICAgICAvLyBUT0RPOiB0aGVyZSdzIHByb2JhYmx5IGEgX211Y2hfIG1vcmUgZXhwbGljaXQgYW5kIGJldHRlciB3YXkgdG8gaGFuZGxlIHRoaXNcbiAgICAgIGNvbnN0IHNxdWFyZUltYWdlID0gaW1hZ2VzLmZpbmQoKGltYWdlKSA9PlxuICAgICAgICBpbWFnZS5rZXkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3F1YXJlJylcbiAgICAgICk7XG4gICAgICBpZiAoc3F1YXJlSW1hZ2UpIHJldHVybiB7IC4uLnNxdWFyZUltYWdlLCBfX3R5cGVuYW1lOiAnSW1hZ2VNZWRpYScgfTtcbiAgICAgIHJldHVybiB7IC4uLmltYWdlc1swXSwgX190eXBlbmFtZTogJ0ltYWdlTWVkaWEnIH07XG4gICAgfTtcblxuICAgIGxldCBkZWZhdWx0SW1hZ2VzID0gZGVmYXVsdENvbnRlbnRJdGVtUmVzb2x2ZXJzLmltYWdlcyhyb290KSB8fCBbXTtcbiAgICBkZWZhdWx0SW1hZ2VzID0gZGVmYXVsdEltYWdlcy5maWx0ZXIoKGltYWdlKSA9PiBpbWFnZS5zb3VyY2VzLmxlbmd0aCk7IC8vIGZpbHRlciBpbWFnZXMgdy9vIFVSTHNcbiAgICBpZiAoZGVmYXVsdEltYWdlcy5sZW5ndGgpIHJldHVybiBwaWNrQmVzdEltYWdlKGRlZmF1bHRJbWFnZXMpO1xuXG4gICAgLy8gSWYgbm8gaW1hZ2UsIGNoZWNrIHBhcmVudCBmb3IgaW1hZ2U6XG4gICAgY29uc3QgcGFyZW50SXRlbXNDdXJzb3IgPSBhd2FpdCBkYXRhU291cmNlcy5Db250ZW50SXRlbS5nZXRDdXJzb3JCeUNoaWxkQ29udGVudEl0ZW1JZChcbiAgICAgIHJvb3QuaWRcbiAgICApO1xuICAgIGlmICghcGFyZW50SXRlbXNDdXJzb3IpIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgcGFyZW50SXRlbXMgPSBhd2FpdCBwYXJlbnRJdGVtc0N1cnNvci5nZXQoKTtcblxuICAgIGlmIChwYXJlbnRJdGVtcy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IHBhcmVudEltYWdlcyA9IHBhcmVudEl0ZW1zXG4gICAgICAgIC5tYXAoZGVmYXVsdENvbnRlbnRJdGVtUmVzb2x2ZXJzLmltYWdlcylcbiAgICAgICAgLmZpbmQoKGltYWdlcykgPT4gaW1hZ2VzLmxlbmd0aClcbiAgICAgICAgLmZpbHRlcigoaW1hZ2UpID0+IGltYWdlLnNvdXJjZXMubGVuZ3RoKTsgLy8gZmlsdGVyIGltYWdlcyB3L28gVVJMc1xuXG4gICAgICBpZiAocGFyZW50SW1hZ2VzICYmIHBhcmVudEltYWdlcy5sZW5ndGgpXG4gICAgICAgIHJldHVybiBwaWNrQmVzdEltYWdlKHBhcmVudEltYWdlcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH0sXG5cbiAgdGhlbWU6ICgpID0+IG51bGwsIC8vIHRvZG86IGludGVncmF0ZSB0aGVtZXMgZnJvbSBSb2NrXG5cbiAgc2hhcmluZzogKHJvb3QpID0+ICh7IF9fdHlwZTogJ1NoYXJhYmxlQ29udGVudEl0ZW0nLCAuLi5yb290IH0pLFxufTtcblxuZXhwb3J0IGNvbnN0IHJlc29sdmVyID0ge1xuICBRdWVyeToge1xuICAgIHVzZXJGZWVkOiAocm9vdCwgYXJncywgeyBkYXRhU291cmNlcyB9KSA9PlxuICAgICAgZGF0YVNvdXJjZXMuQ29udGVudEl0ZW0ucGFnaW5hdGUoe1xuICAgICAgICBjdXJzb3I6IGRhdGFTb3VyY2VzLkNvbnRlbnRJdGVtLmJ5VXNlckZlZWQoKSxcbiAgICAgICAgYXJncyxcbiAgICAgIH0pLFxuICB9LFxuICBEZXZvdGlvbmFsQ29udGVudEl0ZW06IHtcbiAgICAuLi5kZWZhdWx0Q29udGVudEl0ZW1SZXNvbHZlcnMsXG4gICAgc2NyaXB0dXJlczogKHsgYXR0cmlidXRlVmFsdWVzIH0sIGFyZ3MsIHsgZGF0YVNvdXJjZXMgfSkgPT4ge1xuICAgICAgY29uc3QgcmVmZXJlbmNlID0gZ2V0KGF0dHJpYnV0ZVZhbHVlcywgJ3NjcmlwdHVyZXMudmFsdWUnKTtcbiAgICAgIGlmIChyZWZlcmVuY2UgJiYgcmVmZXJlbmNlICE9IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGRhdGFTb3VyY2VzLlNjcmlwdHVyZS5nZXRTY3JpcHR1cmVzKHJlZmVyZW5jZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9LFxuICB9LFxuICBVbml2ZXJzYWxDb250ZW50SXRlbToge1xuICAgIC4uLmRlZmF1bHRDb250ZW50SXRlbVJlc29sdmVycyxcbiAgfSxcbiAgQ29udGVudFNlcmllc0NvbnRlbnRJdGVtOiB7XG4gICAgLi4uZGVmYXVsdENvbnRlbnRJdGVtUmVzb2x2ZXJzLFxuICB9LFxuICBNZWRpYUNvbnRlbnRJdGVtOiB7XG4gICAgLi4uZGVmYXVsdENvbnRlbnRJdGVtUmVzb2x2ZXJzLFxuICB9LFxuICBDb250ZW50SXRlbToge1xuICAgIC4uLmRlZmF1bHRDb250ZW50SXRlbVJlc29sdmVycyxcbiAgICBfX3Jlc29sdmVUeXBlOiBhc3luYyAoe1xuICAgICAgYXR0cmlidXRlVmFsdWVzLFxuICAgICAgYXR0cmlidXRlcyxcbiAgICAgIGNvbnRlbnRDaGFubmVsVHlwZUlkLFxuICAgIH0pID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgaGFzU2NyaXB0dXJlKHsgYXR0cmlidXRlVmFsdWVzIH0pICYmXG4gICAgICAgIFJPQ0tfTUFQUElOR1MuREVWT1RJT05BTF9UWVBFX0lEUy5pbmNsdWRlcyhjb250ZW50Q2hhbm5lbFR5cGVJZClcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gJ0Rldm90aW9uYWxDb250ZW50SXRlbSc7XG4gICAgICB9XG5cbiAgICAgIGlmIChcbiAgICAgICAgUk9DS19NQVBQSU5HUy5TRVJJRVNfQ09OVEVOVF9DSEFOTkVMX1RZUEVfSURTLmluY2x1ZGVzKFxuICAgICAgICAgIGNvbnRlbnRDaGFubmVsVHlwZUlkXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gJ0NvbnRlbnRTZXJpZXNDb250ZW50SXRlbSc7XG4gICAgICB9XG5cbiAgICAgIGlmIChoYXNNZWRpYSh7IGF0dHJpYnV0ZVZhbHVlcywgYXR0cmlidXRlcyB9KSkge1xuICAgICAgICByZXR1cm4gJ01lZGlhQ29udGVudEl0ZW0nO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gJ1VuaXZlcnNhbENvbnRlbnRJdGVtJztcbiAgICB9LFxuICB9LFxuICBTaGFyYWJsZUNvbnRlbnRJdGVtOiB7XG4gICAgdXJsOiAoKSA9PiAnaHR0cHM6Ly9hcG9sbG9zcm9jay5uZXdzcHJpbmcuY2MvJywgLy8gdG9kbzogcmV0dXJuIGEgZHluYW1pYyB1cmwgdGhhdCBsaW5rcyB0byB0aGUgY29udGVudCBpdGVtXG4gICAgdGl0bGU6ICh7IHRpdGxlIH0pID0+IHRpdGxlLFxuICAgIG1lc3NhZ2U6ICgpID0+ICcnLFxuICB9LFxuICBDb250ZW50SXRlbXNDb25uZWN0aW9uOiB7XG4gICAgcGFnZUluZm86IHdpdGhFZGdlUGFnaW5hdGlvbixcbiAgfSxcbn07XG4iXX0=