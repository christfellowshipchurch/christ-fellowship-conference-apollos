"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.dataSource = void 0;

var _rockApolloDataSource = _interopRequireDefault(require("@apollosproject/rock-apollo-data-source"));

var _config = _interopRequireDefault(require("@apollosproject/config"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  ROCK_MAPPINGS
} = _config.default;

const mapApollosNameToRockName = name => {
  if (ROCK_MAPPINGS.CONTENT_ITEM_TYPES.includes(name)) {
    return 'ContentChannelItem';
  }

  throw new Error(`${name} has not been mapped into a Rock type!`);
};

class RockConstants extends _rockApolloDataSource.default {
  async findOrCreate({
    model,
    objectAttributes
  }) {
    // Turns {ChannelId: 7, Name: 'Something'} into '(ChannelId eq 7) and (Name eq 'Something')'
    const filter = Object.keys(objectAttributes).map(key => {
      if (typeof objectAttributes[key] === 'string') {
        return `(${key} eq '${objectAttributes[key]}')`;
      }

      return `(${key} eq ${objectAttributes[key]})`;
    }).join(' and ');
    const objects = await this.request(model).filter(filter).cache({
      ttl: 86400
    }).get();

    if (objects.length) {
      return objects[0];
    }

    const objectId = await this.post(`/${model}`, objectAttributes);
    const ret = await this.get(`/${model}/${objectId}`);
    console.log('Created', ret);
    return ret;
  }

  async createOrFindInteractionComponent({
    componentName,
    channelId,
    entityId
  }) {
    return this.findOrCreate({
      model: 'InteractionComponents',
      objectAttributes: {
        Name: componentName,
        ChannelId: channelId,
        EntityId: entityId
      }
    });
  }

  async createOrFindInteractionChannel({
    channelName,
    entityTypeId
  }) {
    return this.findOrCreate({
      model: 'InteractionChannels',
      objectAttributes: {
        Name: channelName,
        UsesSession: true,
        IsActive: true,
        ComponentEntityTypeId: entityTypeId,
        ChannelTypeMediumValueId: ROCK_MAPPINGS.INTERACTIONS.CHANNEL_MEDIUM_TYPE_ID
      }
    });
  }

  async contentItemInteractionComponent({
    contentItemId,
    contentName = null
  }) {
    const channel = await this.contentItemInteractionChannel();
    return this.createOrFindInteractionComponent({
      componentName: `${ROCK_MAPPINGS.INTERACTIONS.COMPONENT_NAME} - ${contentName || contentItemId}`,
      channelId: channel.id,
      entityId: parseInt(contentItemId, 10)
    });
  }

  async contentItemInteractionChannel() {
    const {
      id
    } = await this.modelType('ContentItem');
    return this.createOrFindInteractionChannel({
      channelName: ROCK_MAPPINGS.INTERACTIONS.CHANNEL_NAME,
      entityTypeId: id
    });
  }

  async modelType(nameInput) {
    const name = mapApollosNameToRockName(nameInput);
    const types = await this.request('EntityTypes').filter(`Name eq 'Rock.Model.${name}'`).cache({
      ttl: 86400
    }).get();

    if (types.length) {
      return types[0];
    }

    return null;
  }

} // eslint-disable-next-line import/prefer-default-export


exports.dataSource = RockConstants;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb2NrLWNvbnN0YW50cy9pbmRleC5qcyJdLCJuYW1lcyI6WyJST0NLX01BUFBJTkdTIiwiQ29uZmlnIiwibWFwQXBvbGxvc05hbWVUb1JvY2tOYW1lIiwibmFtZSIsIkNPTlRFTlRfSVRFTV9UWVBFUyIsImluY2x1ZGVzIiwiRXJyb3IiLCJSb2NrQ29uc3RhbnRzIiwiUm9ja0Fwb2xsb0RhdGFTb3VyY2UiLCJmaW5kT3JDcmVhdGUiLCJtb2RlbCIsIm9iamVjdEF0dHJpYnV0ZXMiLCJmaWx0ZXIiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwia2V5Iiwiam9pbiIsIm9iamVjdHMiLCJyZXF1ZXN0IiwiY2FjaGUiLCJ0dGwiLCJnZXQiLCJsZW5ndGgiLCJvYmplY3RJZCIsInBvc3QiLCJyZXQiLCJjb25zb2xlIiwibG9nIiwiY3JlYXRlT3JGaW5kSW50ZXJhY3Rpb25Db21wb25lbnQiLCJjb21wb25lbnROYW1lIiwiY2hhbm5lbElkIiwiZW50aXR5SWQiLCJOYW1lIiwiQ2hhbm5lbElkIiwiRW50aXR5SWQiLCJjcmVhdGVPckZpbmRJbnRlcmFjdGlvbkNoYW5uZWwiLCJjaGFubmVsTmFtZSIsImVudGl0eVR5cGVJZCIsIlVzZXNTZXNzaW9uIiwiSXNBY3RpdmUiLCJDb21wb25lbnRFbnRpdHlUeXBlSWQiLCJDaGFubmVsVHlwZU1lZGl1bVZhbHVlSWQiLCJJTlRFUkFDVElPTlMiLCJDSEFOTkVMX01FRElVTV9UWVBFX0lEIiwiY29udGVudEl0ZW1JbnRlcmFjdGlvbkNvbXBvbmVudCIsImNvbnRlbnRJdGVtSWQiLCJjb250ZW50TmFtZSIsImNoYW5uZWwiLCJjb250ZW50SXRlbUludGVyYWN0aW9uQ2hhbm5lbCIsIkNPTVBPTkVOVF9OQU1FIiwiaWQiLCJwYXJzZUludCIsIm1vZGVsVHlwZSIsIkNIQU5ORUxfTkFNRSIsIm5hbWVJbnB1dCIsInR5cGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFFQSxNQUFNO0FBQUVB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QUFMLEVBQXRCO0FBQ0EsV0FBTyxLQUFLcEIsZ0NBQUwsQ0FBc0M7QUFDM0NDLE1BQUFBLGFBQWEsRUFBRyxHQUNkOUIsYUFBYSxDQUFDMkMsWUFBZCxDQUEyQk8sY0FDNUIsTUFBS0gsV0FBVyxJQUFJRCxhQUFjLEVBSFE7QUFJM0NmLE1BQUFBLFNBQVMsRUFBRWlCLE9BQU8sQ0FBQ0csRUFKd0I7QUFLM0NuQixNQUFBQSxRQUFRLEVBQUVvQixRQUFRLENBQUNOLGFBQUQsRUFBZ0IsRUFBaEI7QUFMeUIsS0FBdEMsQ0FBUDtBQU9EOztBQUVELFFBQU1HLDZCQUFOLEdBQXNDO0FBQ3BDLFVBQU07QUFBRUUsTUFBQUE7QUFBRixRQUFTLE1BQU0sS0FBS0UsU0FBTCxDQUFlLGFBQWYsQ0FBckI7QUFDQSxXQUFPLEtBQUtqQiw4QkFBTCxDQUFvQztBQUN6Q0MsTUFBQUEsV0FBVyxFQUFFckMsYUFBYSxDQUFDMkMsWUFBZCxDQUEyQlcsWUFEQztBQUV6Q2hCLE1BQUFBLFlBQVksRUFBRWE7QUFGMkIsS0FBcEMsQ0FBUDtBQUlEOztBQUVELFFBQU1FLFNBQU4sQ0FBZ0JFLFNBQWhCLEVBQTJCO0FBQ3pCLFVBQU1wRCxJQUFJLEdBQUdELHdCQUF3QixDQUFDcUQsU0FBRCxDQUFyQztBQUVBLFVBQU1DLEtBQUssR0FBRyxNQUFNLEtBQUtyQyxPQUFMLENBQWEsYUFBYixFQUNqQlAsTUFEaUIsQ0FDVCx1QkFBc0JULElBQUssR0FEbEIsRUFFakJpQixLQUZpQixDQUVYO0FBQUVDLE1BQUFBLEdBQUcsRUFBRTtBQUFQLEtBRlcsRUFHakJDLEdBSGlCLEVBQXBCOztBQUlBLFFBQUlrQyxLQUFLLENBQUNqQyxNQUFWLEVBQWtCO0FBQ2hCLGFBQU9pQyxLQUFLLENBQUMsQ0FBRCxDQUFaO0FBQ0Q7O0FBRUQsV0FBTyxJQUFQO0FBQ0Q7O0FBckY4QyxDLENBdUZqRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSb2NrQXBvbGxvRGF0YVNvdXJjZSBmcm9tICdAYXBvbGxvc3Byb2plY3Qvcm9jay1hcG9sbG8tZGF0YS1zb3VyY2UnO1xuaW1wb3J0IENvbmZpZyBmcm9tICdAYXBvbGxvc3Byb2plY3QvY29uZmlnJztcblxuY29uc3QgeyBST0NLX01BUFBJTkdTIH0gPSBDb25maWc7XG5cbmNvbnN0IG1hcEFwb2xsb3NOYW1lVG9Sb2NrTmFtZSA9IChuYW1lKSA9PiB7XG4gIGlmIChST0NLX01BUFBJTkdTLkNPTlRFTlRfSVRFTV9UWVBFUy5pbmNsdWRlcyhuYW1lKSkge1xuICAgIHJldHVybiAnQ29udGVudENoYW5uZWxJdGVtJztcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYCR7bmFtZX0gaGFzIG5vdCBiZWVuIG1hcHBlZCBpbnRvIGEgUm9jayB0eXBlIWApO1xufTtcblxuY2xhc3MgUm9ja0NvbnN0YW50cyBleHRlbmRzIFJvY2tBcG9sbG9EYXRhU291cmNlIHtcbiAgYXN5bmMgZmluZE9yQ3JlYXRlKHsgbW9kZWwsIG9iamVjdEF0dHJpYnV0ZXMgfSkge1xuICAgIC8vIFR1cm5zIHtDaGFubmVsSWQ6IDcsIE5hbWU6ICdTb21ldGhpbmcnfSBpbnRvICcoQ2hhbm5lbElkIGVxIDcpIGFuZCAoTmFtZSBlcSAnU29tZXRoaW5nJyknXG4gICAgY29uc3QgZmlsdGVyID0gT2JqZWN0LmtleXMob2JqZWN0QXR0cmlidXRlcylcbiAgICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIG9iamVjdEF0dHJpYnV0ZXNba2V5XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gYCgke2tleX0gZXEgJyR7b2JqZWN0QXR0cmlidXRlc1trZXldfScpYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYCgke2tleX0gZXEgJHtvYmplY3RBdHRyaWJ1dGVzW2tleV19KWA7XG4gICAgICB9KVxuICAgICAgLmpvaW4oJyBhbmQgJyk7XG5cbiAgICBjb25zdCBvYmplY3RzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KG1vZGVsKVxuICAgICAgLmZpbHRlcihmaWx0ZXIpXG4gICAgICAuY2FjaGUoeyB0dGw6IDg2NDAwIH0pXG4gICAgICAuZ2V0KCk7XG4gICAgaWYgKG9iamVjdHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gb2JqZWN0c1swXTtcbiAgICB9XG4gICAgY29uc3Qgb2JqZWN0SWQgPSBhd2FpdCB0aGlzLnBvc3QoYC8ke21vZGVsfWAsIG9iamVjdEF0dHJpYnV0ZXMpO1xuICAgIGNvbnN0IHJldCA9IGF3YWl0IHRoaXMuZ2V0KGAvJHttb2RlbH0vJHtvYmplY3RJZH1gKTtcbiAgICBjb25zb2xlLmxvZygnQ3JlYXRlZCcsIHJldCk7XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZU9yRmluZEludGVyYWN0aW9uQ29tcG9uZW50KHtcbiAgICBjb21wb25lbnROYW1lLFxuICAgIGNoYW5uZWxJZCxcbiAgICBlbnRpdHlJZCxcbiAgfSkge1xuICAgIHJldHVybiB0aGlzLmZpbmRPckNyZWF0ZSh7XG4gICAgICBtb2RlbDogJ0ludGVyYWN0aW9uQ29tcG9uZW50cycsXG4gICAgICBvYmplY3RBdHRyaWJ1dGVzOiB7XG4gICAgICAgIE5hbWU6IGNvbXBvbmVudE5hbWUsXG4gICAgICAgIENoYW5uZWxJZDogY2hhbm5lbElkLFxuICAgICAgICBFbnRpdHlJZDogZW50aXR5SWQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlT3JGaW5kSW50ZXJhY3Rpb25DaGFubmVsKHsgY2hhbm5lbE5hbWUsIGVudGl0eVR5cGVJZCB9KSB7XG4gICAgcmV0dXJuIHRoaXMuZmluZE9yQ3JlYXRlKHtcbiAgICAgIG1vZGVsOiAnSW50ZXJhY3Rpb25DaGFubmVscycsXG4gICAgICBvYmplY3RBdHRyaWJ1dGVzOiB7XG4gICAgICAgIE5hbWU6IGNoYW5uZWxOYW1lLFxuICAgICAgICBVc2VzU2Vzc2lvbjogdHJ1ZSxcbiAgICAgICAgSXNBY3RpdmU6IHRydWUsXG4gICAgICAgIENvbXBvbmVudEVudGl0eVR5cGVJZDogZW50aXR5VHlwZUlkLFxuICAgICAgICBDaGFubmVsVHlwZU1lZGl1bVZhbHVlSWQ6XG4gICAgICAgICAgUk9DS19NQVBQSU5HUy5JTlRFUkFDVElPTlMuQ0hBTk5FTF9NRURJVU1fVFlQRV9JRCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBjb250ZW50SXRlbUludGVyYWN0aW9uQ29tcG9uZW50KHsgY29udGVudEl0ZW1JZCwgY29udGVudE5hbWUgPSBudWxsIH0pIHtcbiAgICBjb25zdCBjaGFubmVsID0gYXdhaXQgdGhpcy5jb250ZW50SXRlbUludGVyYWN0aW9uQ2hhbm5lbCgpO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZU9yRmluZEludGVyYWN0aW9uQ29tcG9uZW50KHtcbiAgICAgIGNvbXBvbmVudE5hbWU6IGAke1xuICAgICAgICBST0NLX01BUFBJTkdTLklOVEVSQUNUSU9OUy5DT01QT05FTlRfTkFNRVxuICAgICAgfSAtICR7Y29udGVudE5hbWUgfHwgY29udGVudEl0ZW1JZH1gLFxuICAgICAgY2hhbm5lbElkOiBjaGFubmVsLmlkLFxuICAgICAgZW50aXR5SWQ6IHBhcnNlSW50KGNvbnRlbnRJdGVtSWQsIDEwKSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNvbnRlbnRJdGVtSW50ZXJhY3Rpb25DaGFubmVsKCkge1xuICAgIGNvbnN0IHsgaWQgfSA9IGF3YWl0IHRoaXMubW9kZWxUeXBlKCdDb250ZW50SXRlbScpO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZU9yRmluZEludGVyYWN0aW9uQ2hhbm5lbCh7XG4gICAgICBjaGFubmVsTmFtZTogUk9DS19NQVBQSU5HUy5JTlRFUkFDVElPTlMuQ0hBTk5FTF9OQU1FLFxuICAgICAgZW50aXR5VHlwZUlkOiBpZCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG1vZGVsVHlwZShuYW1lSW5wdXQpIHtcbiAgICBjb25zdCBuYW1lID0gbWFwQXBvbGxvc05hbWVUb1JvY2tOYW1lKG5hbWVJbnB1dCk7XG5cbiAgICBjb25zdCB0eXBlcyA9IGF3YWl0IHRoaXMucmVxdWVzdCgnRW50aXR5VHlwZXMnKVxuICAgICAgLmZpbHRlcihgTmFtZSBlcSAnUm9jay5Nb2RlbC4ke25hbWV9J2ApXG4gICAgICAuY2FjaGUoeyB0dGw6IDg2NDAwIH0pXG4gICAgICAuZ2V0KCk7XG4gICAgaWYgKHR5cGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHR5cGVzWzBdO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG59XG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgaW1wb3J0L3ByZWZlci1kZWZhdWx0LWV4cG9ydFxuZXhwb3J0IHsgUm9ja0NvbnN0YW50cyBhcyBkYXRhU291cmNlIH07XG4iXX0=