"use strict";

var _apolloServerEnv = require("apollo-server-env");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _index = require("../index");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_config.default.loadJs({
  ROCK_MAPPINGS: {
    CONTENT_ITEM_TYPES: ['ContentItem', 'UniversalContentItem', 'DevotionalContentItem', 'MediaContentItem'],
    INTERACTIONS: {
      CHANNEL_NAME: 'Apollos App',
      COMPONENT_NAME: 'Apollos Content Item',
      CHANNEL_MEDIUM_TYPE_ID: 512
    }
  }
});

const buildGetMock = (response, dataSource) => {
  const get = jest.fn();

  if (Array.isArray(response) && Array.isArray(response[0])) {
    response.forEach(responseVal => {
      get.mockReturnValueOnce(new Promise(resolve => resolve(dataSource.normalize(responseVal))));
    });
  }

  get.mockReturnValue(new Promise(resolve => resolve(dataSource.normalize(response))));
  return get;
};

describe('RockConstants', () => {
  beforeEach(() => {
    _apolloServerEnv.fetch.resetMocks();
  });
  it("creates a Channel if it doesn't exist", async () => {
    const dataSource = new _index.dataSource();
    dataSource.modelType = buildGetMock({
      id: 101
    }, dataSource);
    dataSource.get = buildGetMock([[], {
      Id: 1
    }], dataSource);
    dataSource.post = buildGetMock('1', dataSource);
    const result = await dataSource.contentItemInteractionChannel();
    expect(result).toMatchSnapshot();
    expect(dataSource.modelType.mock.calls).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
    expect(dataSource.post.mock.calls).toMatchSnapshot();
  });
  it('finds the Channel if it exists', async () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([{
      Id: 1
    }], dataSource);
    dataSource.post = jest.fn();
    const result = await dataSource.contentItemInteractionChannel();
    expect(result).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
    expect(dataSource.post.mock.calls.length).toBe(0);
  });
  it("creates a Component if it doesn't exist", async () => {
    const dataSource = new _index.dataSource();
    dataSource.modelType = buildGetMock({
      id: 101
    }, dataSource);
    dataSource.get = buildGetMock([[], {
      Id: 1
    }], dataSource);
    dataSource.post = buildGetMock('1', dataSource);
    const result = await dataSource.contentItemInteractionComponent({
      contentItemId: 7,
      contentTitle: 'Some Title'
    });
    expect(result).toMatchSnapshot();
    expect(dataSource.modelType.mock.calls).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
    expect(dataSource.post.mock.calls).toMatchSnapshot();
  });
  it('finds the Component if it exists', async () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([{
      Id: 1
    }], dataSource);
    dataSource.post = jest.fn();
    const result = await dataSource.contentItemInteractionComponent({
      contentItemId: 7,
      contentTitle: 'Some Title'
    });
    expect(result).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
    expect(dataSource.post.mock.calls.length).toBe(0);
  });
  it('finds a ContentItem model ID', async () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([{
      Id: 1
    }], dataSource);
    const result = await dataSource.modelType('ContentItem');
    expect(result).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
  });
  it('finds a UniversalContentItem model ID', async () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([{
      Id: 1
    }], dataSource);
    const result = await dataSource.modelType('UniversalContentItem');
    expect(result).toMatchSnapshot();
    expect(dataSource.get.mock.calls).toMatchSnapshot();
  });
  it('Throws when finding an unknown model ', () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([{
      Id: 1
    }], dataSource);
    const prom = dataSource.modelType('IDontExist');
    expect(prom).rejects.toEqual(new Error('IDontExist has not been mapped into a Rock type!'));
  });
  it('Returns null if model type not found ', async () => {
    const dataSource = new _index.dataSource();
    dataSource.get = buildGetMock([], dataSource);
    const result = await dataSource.modelType('ContentItem');
    expect(result).toEqual(null);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yb2NrLWNvbnN0YW50cy9fX3Rlc3RzX18vcm9jay1jb25zdGFudHMudGVzdHMuanMiXSwibmFtZXMiOlsiQXBvbGxvc0NvbmZpZyIsImxvYWRKcyIsIlJPQ0tfTUFQUElOR1MiLCJDT05URU5UX0lURU1fVFlQRVMiLCJJTlRFUkFDVElPTlMiLCJDSEFOTkVMX05BTUUiLCJDT01QT05FTlRfTkFNRSIsIkNIQU5ORUxfTUVESVVNX1RZUEVfSUQiLCJidWlsZEdldE1vY2siLCJyZXNwb25zZSIsImRhdGFTb3VyY2UiLCJnZXQiLCJqZXN0IiwiZm4iLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwicmVzcG9uc2VWYWwiLCJtb2NrUmV0dXJuVmFsdWVPbmNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJub3JtYWxpemUiLCJtb2NrUmV0dXJuVmFsdWUiLCJkZXNjcmliZSIsImJlZm9yZUVhY2giLCJmZXRjaCIsInJlc2V0TW9ja3MiLCJpdCIsIlJvY2tDb25zdGFudHMiLCJtb2RlbFR5cGUiLCJpZCIsIklkIiwicG9zdCIsInJlc3VsdCIsImNvbnRlbnRJdGVtSW50ZXJhY3Rpb25DaGFubmVsIiwiZXhwZWN0IiwidG9NYXRjaFNuYXBzaG90IiwibW9jayIsImNhbGxzIiwibGVuZ3RoIiwidG9CZSIsImNvbnRlbnRJdGVtSW50ZXJhY3Rpb25Db21wb25lbnQiLCJjb250ZW50SXRlbUlkIiwiY29udGVudFRpdGxlIiwicHJvbSIsInJlamVjdHMiLCJ0b0VxdWFsIiwiRXJyb3IiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQUEsZ0JBQWNDLE1BQWQsQ0FBcUI7QUFDbkJDLEVBQUFBLGFBQWEsRUFBRTtBQUNiQyxJQUFBQSxrQkFBa0IsRUFBRSxDQUNsQixhQURrQixFQUVsQixzQkFGa0IsRUFHbEIsdUJBSGtCLEVBSWxCLGtCQUprQixDQURQO0FBT2JDLElBQUFBLFlBQVksRUFBRTtBQUNaQyxNQUFBQSxZQUFZLEVB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LElBQUlDLEtBQUosQ0FBVSxrREFBVixDQURGO0FBR0QsR0FQQyxDQUFGO0FBUUFwQixFQUFBQSxFQUFFLENBQUMsdUNBQUQsRUFBMEMsWUFBWTtBQUN0RCxVQUFNakIsVUFBVSxHQUFHLElBQUlrQixpQkFBSixFQUFuQjtBQUNBbEIsSUFBQUEsVUFBVSxDQUFDQyxHQUFYLEdBQWlCSCxZQUFZLENBQUMsRUFBRCxFQUFLRSxVQUFMLENBQTdCO0FBQ0EsVUFBTXVCLE1BQU0sR0FBRyxNQUFNdkIsVUFBVSxDQUFDbUIsU0FBWCxDQUFxQixhQUFyQixDQUFyQjtBQUNBTSxJQUFBQSxNQUFNLENBQUNGLE1BQUQsQ0FBTixDQUFlYSxPQUFmLENBQXVCLElBQXZCO0FBQ0QsR0FMQyxDQUFGO0FBTUQsQ0E5RU8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZldGNoIH0gZnJvbSAnYXBvbGxvLXNlcnZlci1lbnYnO1xuaW1wb3J0IEFwb2xsb3NDb25maWcgZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L2NvbmZpZyc7XG5pbXBvcnQgeyBkYXRhU291cmNlIGFzIFJvY2tDb25zdGFudHMgfSBmcm9tICcuLi9pbmRleCc7XG5cbkFwb2xsb3NDb25maWcubG9hZEpzKHtcbiAgUk9DS19NQVBQSU5HUzoge1xuICAgIENPTlRFTlRfSVRFTV9UWVBFUzogW1xuICAgICAgJ0NvbnRlbnRJdGVtJyxcbiAgICAgICdVbml2ZXJzYWxDb250ZW50SXRlbScsXG4gICAgICAnRGV2b3Rpb25hbENvbnRlbnRJdGVtJyxcbiAgICAgICdNZWRpYUNvbnRlbnRJdGVtJyxcbiAgICBdLFxuICAgIElOVEVSQUNUSU9OUzoge1xuICAgICAgQ0hBTk5FTF9OQU1FOiAnQXBvbGxvcyBBcHAnLFxuICAgICAgQ09NUE9ORU5UX05BTUU6ICdBcG9sbG9zIENvbnRlbnQgSXRlbScsXG4gICAgICBDSEFOTkVMX01FRElVTV9UWVBFX0lEOiA1MTIsXG4gICAgfSxcbiAgfSxcbn0pO1xuXG5jb25zdCBidWlsZEdldE1vY2sgPSAocmVzcG9uc2UsIGRhdGFTb3VyY2UpID0+IHtcbiAgY29uc3QgZ2V0ID0gamVzdC5mbigpO1xuICBpZiAoQXJyYXkuaXNBcnJheShyZXNwb25zZSkgJiYgQXJyYXkuaXNBcnJheShyZXNwb25zZVswXSkpIHtcbiAgICByZXNwb25zZS5mb3JFYWNoKChyZXNwb25zZVZhbCkgPT4ge1xuICAgICAgZ2V0Lm1vY2tSZXR1cm5WYWx1ZU9uY2UoXG4gICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXNvbHZlKGRhdGFTb3VyY2Uubm9ybWFsaXplKHJlc3BvbnNlVmFsKSkpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG4gIGdldC5tb2NrUmV0dXJuVmFsdWUoXG4gICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoZGF0YVNvdXJjZS5ub3JtYWxpemUocmVzcG9uc2UpKSlcbiAgKTtcbiAgcmV0dXJuIGdldDtcbn07XG5cbmRlc2NyaWJlKCdSb2NrQ29uc3RhbnRzJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBmZXRjaC5yZXNldE1vY2tzKCk7XG4gIH0pO1xuICBpdChcImNyZWF0ZXMgYSBDaGFubmVsIGlmIGl0IGRvZXNuJ3QgZXhpc3RcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UubW9kZWxUeXBlID0gYnVpbGRHZXRNb2NrKHsgaWQ6IDEwMSB9LCBkYXRhU291cmNlKTtcbiAgICBkYXRhU291cmNlLmdldCA9IGJ1aWxkR2V0TW9jayhbW10sIHsgSWQ6IDEgfV0sIGRhdGFTb3VyY2UpO1xuICAgIGRhdGFTb3VyY2UucG9zdCA9IGJ1aWxkR2V0TW9jaygnMScsIGRhdGFTb3VyY2UpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRhdGFTb3VyY2UuY29udGVudEl0ZW1JbnRlcmFjdGlvbkNoYW5uZWwoKTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgICBleHBlY3QoZGF0YVNvdXJjZS5tb2RlbFR5cGUubW9jay5jYWxscykudG9NYXRjaFNuYXBzaG90KCk7XG4gICAgZXhwZWN0KGRhdGFTb3VyY2UuZ2V0Lm1vY2suY2FsbHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgIGV4cGVjdChkYXRhU291cmNlLnBvc3QubW9jay5jYWxscykudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xuICBpdCgnZmluZHMgdGhlIENoYW5uZWwgaWYgaXQgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UuZ2V0ID0gYnVpbGRHZXRNb2NrKFt7IElkOiAxIH1dLCBkYXRhU291cmNlKTtcbiAgICBkYXRhU291cmNlLnBvc3QgPSBqZXN0LmZuKCk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGF0YVNvdXJjZS5jb250ZW50SXRlbUludGVyYWN0aW9uQ2hhbm5lbCgpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgIGV4cGVjdChkYXRhU291cmNlLmdldC5tb2NrLmNhbGxzKS50b01hdGNoU25hcHNob3QoKTtcbiAgICBleHBlY3QoZGF0YVNvdXJjZS5wb3N0Lm1vY2suY2FsbHMubGVuZ3RoKS50b0JlKDApO1xuICB9KTtcbiAgaXQoXCJjcmVhdGVzIGEgQ29tcG9uZW50IGlmIGl0IGRvZXNuJ3QgZXhpc3RcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UubW9kZWxUeXBlID0gYnVpbGRHZXRNb2NrKHsgaWQ6IDEwMSB9LCBkYXRhU291cmNlKTtcbiAgICBkYXRhU291cmNlLmdldCA9IGJ1aWxkR2V0TW9jayhbW10sIHsgSWQ6IDEgfV0sIGRhdGFTb3VyY2UpO1xuICAgIGRhdGFTb3VyY2UucG9zdCA9IGJ1aWxkR2V0TW9jaygnMScsIGRhdGFTb3VyY2UpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRhdGFTb3VyY2UuY29udGVudEl0ZW1JbnRlcmFjdGlvbkNvbXBvbmVudCh7XG4gICAgICBjb250ZW50SXRlbUlkOiA3LFxuICAgICAgY29udGVudFRpdGxlOiAnU29tZSBUaXRsZScsXG4gICAgfSk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gICAgZXhwZWN0KGRhdGFTb3VyY2UubW9kZWxUeXBlLm1vY2suY2FsbHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgIGV4cGVjdChkYXRhU291cmNlLmdldC5tb2NrLmNhbGxzKS50b01hdGNoU25hcHNob3QoKTtcbiAgICBleHBlY3QoZGF0YVNvdXJjZS5wb3N0Lm1vY2suY2FsbHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcbiAgaXQoJ2ZpbmRzIHRoZSBDb21wb25lbnQgaWYgaXQgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UuZ2V0ID0gYnVpbGRHZXRNb2NrKFt7IElkOiAxIH1dLCBkYXRhU291cmNlKTtcbiAgICBkYXRhU291cmNlLnBvc3QgPSBqZXN0LmZuKCk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGF0YVNvdXJjZS5jb250ZW50SXRlbUludGVyYWN0aW9uQ29tcG9uZW50KHtcbiAgICAgIGNvbnRlbnRJdGVtSWQ6IDcsXG4gICAgICBjb250ZW50VGl0bGU6ICdTb21lIFRpdGxlJyxcbiAgICB9KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgICBleHBlY3QoZGF0YVNvdXJjZS5nZXQubW9jay5jYWxscykudG9NYXRjaFNuYXBzaG90KCk7XG4gICAgZXhwZWN0KGRhdGFTb3VyY2UucG9zdC5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgwKTtcbiAgfSk7XG4gIGl0KCdmaW5kcyBhIENvbnRlbnRJdGVtIG1vZGVsIElEJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UuZ2V0ID0gYnVpbGRHZXRNb2NrKFt7IElkOiAxIH1dLCBkYXRhU291cmNlKTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYXRhU291cmNlLm1vZGVsVHlwZSgnQ29udGVudEl0ZW0nKTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgICBleHBlY3QoZGF0YVNvdXJjZS5nZXQubW9jay5jYWxscykudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xuICBpdCgnZmluZHMgYSBVbml2ZXJzYWxDb250ZW50SXRlbSBtb2RlbCBJRCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBkYXRhU291cmNlID0gbmV3IFJvY2tDb25zdGFudHMoKTtcbiAgICBkYXRhU291cmNlLmdldCA9IGJ1aWxkR2V0TW9jayhbeyBJZDogMSB9XSwgZGF0YVNvdXJjZSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGF0YVNvdXJjZS5tb2RlbFR5cGUoJ1VuaXZlcnNhbENvbnRlbnRJdGVtJyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gICAgZXhwZWN0KGRhdGFTb3VyY2UuZ2V0Lm1vY2suY2FsbHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcbiAgaXQoJ1Rocm93cyB3aGVuIGZpbmRpbmcgYW4gdW5rbm93biBtb2RlbCAnLCAoKSA9PiB7XG4gICAgY29uc3QgZGF0YVNvdXJjZSA9IG5ldyBSb2NrQ29uc3RhbnRzKCk7XG4gICAgZGF0YVNvdXJjZS5nZXQgPSBidWlsZEdldE1vY2soW3sgSWQ6IDEgfV0sIGRhdGFTb3VyY2UpO1xuICAgIGNvbnN0IHByb20gPSBkYXRhU291cmNlLm1vZGVsVHlwZSgnSURvbnRFeGlzdCcpO1xuICAgIGV4cGVjdChwcm9tKS5yZWplY3RzLnRvRXF1YWwoXG4gICAgICBuZXcgRXJyb3IoJ0lEb250RXhpc3QgaGFzIG5vdCBiZWVuIG1hcHBlZCBpbnRvIGEgUm9jayB0eXBlIScpXG4gICAgKTtcbiAgfSk7XG4gIGl0KCdSZXR1cm5zIG51bGwgaWYgbW9kZWwgdHlwZSBub3QgZm91bmQgJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGFTb3VyY2UgPSBuZXcgUm9ja0NvbnN0YW50cygpO1xuICAgIGRhdGFTb3VyY2UuZ2V0ID0gYnVpbGRHZXRNb2NrKFtdLCBkYXRhU291cmNlKTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYXRhU291cmNlLm1vZGVsVHlwZSgnQ29udGVudEl0ZW0nKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG51bGwpO1xuICB9KTtcbn0pO1xuIl19