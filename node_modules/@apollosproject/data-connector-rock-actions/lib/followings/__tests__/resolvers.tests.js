"use strict";

var _graphql = require("graphql");

var _apolloServerEnv = require("apollo-server-env");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _serverCore = require("@apollosproject/server-core");

var _apolloServer = require("apollo-server");

var _lodash = require("lodash");

var _dataSchema = require("@apollosproject/data-schema");

var _dataConnectorRockAuth = require("@apollosproject/data-connector-rock-auth");

var _testUtils = require("@apollosproject/server-core/lib/testUtils");

var Followings = _interopRequireWildcard(require("../index"));

var RockConstants = _interopRequireWildcard(require("../../rock-constants"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ContentItemDataSource {
  // eslint-disable-next-line class-methods-use-this
  initialize() {} // eslint-disable-next-line class-methods-use-this


  getFromId(id) {
    return {
      id
    };
  } // eslint-disable-next-line class-methods-use-this


  getFromIds(ids) {
    return {
      get: () => ids.map(id => ({
        id
      }))
    };
  }

}

class AuthDataSource {
  initialize({
    context
  }) {
    this.context = context;
  }

  getCurrentPerson() {
    if (this.context.currentPerson) {
      return {
        id: 'someId'
      };
    }

    throw new _apolloServer.AuthenticationError('Must be logged in');
  }

}

const ContentItem = {
  dataSource: ContentItemDataSource,
  resolver: {
    ContentItem: {
      __resolveType: () => 'UniversalContentItem'
    },
    UniversalContentItem: {
      id: ({
        id
      }) => (0, _serverCore.createGlobalId)(id, 'UniversalContentItem')
    }
  }
};
const Auth = {
  dataSource: AuthDataSource,
  contextMiddleware: ({
    req,
    context
  }) => {
    if ((0, _lodash.get)(req, 'headers.authorization')) {
      return { ...context,
        currentPerson: true
      };
    }

    return { ...context
    };
  }
};
const {
  getSchema,
  getContext
} = (0, _testUtils.createTestHelpers)({
  Followings,
  RockConstants,
  ContentItem,
  UniversalContentItem: ContentItem,
  Auth
});

_config.default.loadJs({
  ROCK: {
    API_URL: 'https://apollosrock.newspring.cc/api',
    API_TOKEN: 'some-rock-token',
    IMAGE_URL: 'https://apollosrock.newspring.cc/GetImage.ashx'
  },
  ROCK_MAPPINGS: {
    SERIES_CONTENT_CHANNEL_TYPE_IDS: [6, 7],
    CONTENT_ITEM_TYPES: ['ContentItem', 'UniversalContentItem', 'DevotionalContentItem', 'MediaContentItem']
  },
  APP: {
    DEEP_LINK_HOST: 'apolloschurch'
  }
});

describe('Following', () => {
  let schema;
  let context;
  beforeEach(() => {
    _apolloServerEnv.fetch.resetMocks();

    _apolloServerEnv.fetch.mockRockDataSourceAPI();

    schema = getSchema([_dataSchema.contentItemSchema, _dataSchema.contentChannelSchema, _dataSchema.themeSchema, _dataSchema.scriptureSchema]);
    const token = (0, _dataConnectorRockAuth.generateToken)({
      cookie: 'some-cookie',
      sessionId: 123
    });
    context = getContext({
      req: {
        headers: {
          authorization: token
        }
      }
    });
  });
  it('likes an entity', async () => {
    const query = `
      mutation likeEntity {
        updateLikeEntity(
          input: {
            nodeId: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}"
            operation: Like
          }
        ) {
          id
          isLiked
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('unlikes an entity', async () => {
    const query = `
      mutation likeEntity {
        updateLikeEntity(
          input: {
            nodeId: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}"
            operation: Unlike
          }
        ) {
          id
          isLiked
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('uses following table to track if a user liked content', async () => {
    const query = `
      query getContent {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}") {
          id
          ... on ContentItem {
            isLiked
          }
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('returns isLiked false if a user is logged out', async () => {
    const query = `
      query getContent {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}") {
          id
          ... on ContentItem {
            isLiked
          }
        }
      }
    `;
    const contextWithoutUser = getContext();
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, contextWithoutUser);
    expect(result).toMatchSnapshot();
  });
  it('returns a likeCount', async () => {
    const query = `
      query getContent {
        node(id: "${(0, _serverCore.createGlobalId)(1, 'UniversalContentItem')}") {
          id
          ... on ContentItem {
            likedCount
          }
        }
      }
    `;
    const contextWithoutUser = getContext();
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, contextWithoutUser);
    expect(result).toMatchSnapshot();
  });
  it('gets all user liked content', async () => {
    const query = `
      query {
        getAllLikedContent {
          id
          isLiked
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('returns an empty array for liked content without a user logged in', async () => {
    const query = `
      query {
        getAllLikedContent {
          id
          isLiked
        }
      }
    `;
    const contextWithoutUser = getContext();
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, contextWithoutUser);
    expect(result).toMatchSnapshot();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9mb2xsb3dpbmdzL19fdGVzdHNfXy9yZXNvbHZlcnMudGVzdHMuanMiXSwibmFtZXMiOlsiQ29udGVudEl0ZW1EYXRhU291cmNlIiwiaW5pdGlhbGl6ZSIsImdldEZyb21JZCIsImlkIiwiZ2V0RnJvbUlkcyIsImlkcyIsImdldCIsIm1hcCIsIkF1dGhEYXRhU291cmNlIiwiY29udGV4dCIsImdldEN1cnJlbnRQZXJzb24iLCJjdXJyZW50UGVyc29uIiwiQXV0aGVudGljYXRpb25FcnJvciIsIkNvbnRlbnRJdGVtIiwiZGF0YVNvdXJjZSIsInJlc29sdmVyIiwiX19yZXNvbHZlVHlwZSIsIlVuaXZlcnNhbENvbnRlbnRJdGVtIiwiQXV0aCIsImNvbnRleHRNaWRkbGV3YXJlIiwicmVxIiwiZ2V0U2NoZW1hIiwiZ2V0Q29udGV4dCIsIkZvbGxvd2luZ3MiLCJSb2NrQ29uc3RhbnRzIiwiQXBvbGxvc0NvbmZpZyIsImxvYWRKcyIsIlJPQ0siLCJBUElfVVJMIiwiQVBJX1RPS0VOIiwiSU1BR0VfVVJMIiwiUk9DS19NQVBQSU5HUyIsIlNFUklFU19DT05URU5UX0NIQU5ORUxfVFlQRV9JRFMiLCJDT05URU5UX0lURU1fVFlQRVMiLCJBUFAiLCJERUVQX0xJTktfSE9TVCIsImRlc2NyaWJlIiwic2NoZW1hIiwiYmVmb3JlRWFjaCIsImZldGNoIiwicmVzZXRNb2NrcyIsIm1vY2tSb2NrRGF0YVNvdXJjZUFQSSIsImNvbnRlbnRJdGVtU2NoZW1hIiwiY29udGVudENoYW5uZWxTY2hlbWEiLCJ0aGVtZVNjaGVtYSIsInNjcmlwdHVyZVNjaGVtYSIsInRva2VuIiwiY29va2llIiwic2Vzc2lvbklkIiwiaGVhZGVycyIsImF1dGhvcml6YXRpb24iLCJpdCIsInF1ZXJ5Iiwicm9vdFZhbHVlIiwicmVzdWx0IiwiZXhwZWN0IiwidG9NYXRjaFNuYXBzaG90IiwiY29udGV4dFdpdGhvdXRVc2VyIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBOztB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Q0ksa0JBQWxDLENBQXJCO0FBQ0FGLElBQUFBLE1BQU0sQ0FBQ0QsTUFBRCxDQUFOLENBQWVFLGVBQWY7QUFDRCxHQWZDLENBQUY7QUFpQkFMLEVBQUFBLEVBQUUsQ0FBQyw2QkFBRCxFQUFnQyxZQUFZO0FBQzVDLFVBQU1DLEtBQUssR0FBSTs7Ozs7OztLQUFmO0FBUUEsVUFBTUMsU0FBUyxHQUFHLEVBQWxCO0FBQ0EsVUFBTUMsTUFBTSxHQUFHLE1BQU0sc0JBQVFqQixNQUFSLEVBQWdCZSxLQUFoQixFQUF1QkMsU0FBdkIsRUFBa0M1QyxPQUFsQyxDQUFyQjtBQUNBOEMsSUFBQUEsTUFBTSxDQUFDRCxNQUFELENBQU4sQ0FBZUUsZUFBZjtBQUNELEdBWkMsQ0FBRjtBQWNBTCxFQUFBQSxFQUFFLENBQUMsbUVBQUQsRUFBc0UsWUFBWTtBQUNsRixVQUFNQyxLQUFLLEdBQUk7Ozs7Ozs7S0FBZjtBQVFBLFVBQU1LLGtCQUFrQixHQUFHbkMsVUFBVSxFQUFyQztBQUNBLFVBQU0rQixTQUFTLEdBQUcsRUFBbEI7QUFDQSxVQUFNQyxNQUFNLEdBQUcsTUFBTSxzQkFBUWpCLE1BQVIsRUFBZ0JlLEtBQWhCLEVBQXVCQyxTQUF2QixFQUFrQ0ksa0JBQWxDLENBQXJCO0FBQ0FGLElBQUFBLE1BQU0sQ0FBQ0QsTUFBRCxDQUFOLENBQWVFLGVBQWY7QUFDRCxHQWJDLENBQUY7QUFjRCxDQXRJTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ3JhcGhxbCB9IGZyb20gJ2dyYXBocWwnO1xuaW1wb3J0IHsgZmV0Y2ggfSBmcm9tICdhcG9sbG8tc2VydmVyLWVudic7XG5pbXBvcnQgQXBvbGxvc0NvbmZpZyBmcm9tICdAYXBvbGxvc3Byb2plY3QvY29uZmlnJztcbmltcG9ydCB7IGNyZWF0ZUdsb2JhbElkIH0gZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L3NlcnZlci1jb3JlJztcbmltcG9ydCB7IEF1dGhlbnRpY2F0aW9uRXJyb3IgfSBmcm9tICdhcG9sbG8tc2VydmVyJztcbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7XG4gIGNvbnRlbnRJdGVtU2NoZW1hLFxuICBjb250ZW50Q2hhbm5lbFNjaGVtYSxcbiAgdGhlbWVTY2hlbWEsXG4gIHNjcmlwdHVyZVNjaGVtYSxcbn0gZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L2RhdGEtc2NoZW1hJztcbmltcG9ydCB7IGdlbmVyYXRlVG9rZW4gfSBmcm9tICdAYXBvbGxvc3Byb2plY3QvZGF0YS1jb25uZWN0b3Itcm9jay1hdXRoJztcbmltcG9ydCB7IGNyZWF0ZVRlc3RIZWxwZXJzIH0gZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L3NlcnZlci1jb3JlL2xpYi90ZXN0VXRpbHMnO1xuaW1wb3J0ICogYXMgRm9sbG93aW5ncyBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgKiBhcyBSb2NrQ29uc3RhbnRzIGZyb20gJy4uLy4uL3JvY2stY29uc3RhbnRzJztcblxuY2xhc3MgQ29udGVudEl0ZW1EYXRhU291cmNlIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgaW5pdGlhbGl6ZSgpIHt9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgZ2V0RnJvbUlkKGlkKSB7XG4gICAgcmV0dXJuIHsgaWQgfTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzXG4gIGdldEZyb21JZHMoaWRzKSB7XG4gICAgcmV0dXJuIHsgZ2V0OiAoKSA9PiBpZHMubWFwKChpZCkgPT4gKHsgaWQgfSkpIH07XG4gIH1cbn1cblxuY2xhc3MgQXV0aERhdGFTb3VyY2Uge1xuICBpbml0aWFsaXplKHsgY29udGV4dCB9KSB7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcbiAgfVxuXG4gIGdldEN1cnJlbnRQZXJzb24oKSB7XG4gICAgaWYgKHRoaXMuY29udGV4dC5jdXJyZW50UGVyc29uKSB7XG4gICAgICByZXR1cm4geyBpZDogJ3NvbWVJZCcgfTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoJ011c3QgYmUgbG9nZ2VkIGluJyk7XG4gIH1cbn1cblxuY29uc3QgQ29udGVudEl0ZW0gPSB7XG4gIGRhdGFTb3VyY2U6IENvbnRlbnRJdGVtRGF0YVNvdXJjZSxcbiAgcmVzb2x2ZXI6IHtcbiAgICBDb250ZW50SXRlbToge1xuICAgICAgX19yZXNvbHZlVHlwZTogKCkgPT4gJ1VuaXZlcnNhbENvbnRlbnRJdGVtJyxcbiAgICB9LFxuICAgIFVuaXZlcnNhbENvbnRlbnRJdGVtOiB7XG4gICAgICBpZDogKHsgaWQgfSkgPT4gY3JlYXRlR2xvYmFsSWQoaWQsICdVbml2ZXJzYWxDb250ZW50SXRlbScpLFxuICAgIH0sXG4gIH0sXG59O1xuXG5jb25zdCBBdXRoID0ge1xuICBkYXRhU291cmNlOiBBdXRoRGF0YVNvdXJjZSxcbiAgY29udGV4dE1pZGRsZXdhcmU6ICh7IHJlcSwgY29udGV4dCB9KSA9PiB7XG4gICAgaWYgKGdldChyZXEsICdoZWFkZXJzLmF1dGhvcml6YXRpb24nKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uY29udGV4dCxcbiAgICAgICAgY3VycmVudFBlcnNvbjogdHJ1ZSxcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7IC4uLmNvbnRleHQgfTtcbiAgfSxcbn07XG5cbmNvbnN0IHsgZ2V0U2NoZW1hLCBnZXRDb250ZXh0IH0gPSBjcmVhdGVUZXN0SGVscGVycyh7XG4gIEZvbGxvd2luZ3MsXG4gIFJvY2tDb25zdGFudHMsXG4gIENvbnRlbnRJdGVtLFxuICBVbml2ZXJzYWxDb250ZW50SXRlbTogQ29udGVudEl0ZW0sXG4gIEF1dGgsXG59KTtcblxuQXBvbGxvc0NvbmZpZy5sb2FkSnMoe1xuICBST0NLOiB7XG4gICAgQVBJX1VSTDogJ2h0dHBzOi8vYXBvbGxvc3JvY2submV3c3ByaW5nLmNjL2FwaScsXG4gICAgQVBJX1RPS0VOOiAnc29tZS1yb2NrLXRva2VuJyxcbiAgICBJTUFHRV9VUkw6ICdodHRwczovL2Fwb2xsb3Nyb2NrLm5ld3NwcmluZy5jYy9HZXRJbWFnZS5hc2h4JyxcbiAgfSxcbiAgUk9DS19NQVBQSU5HUzoge1xuICAgIFNFUklFU19DT05URU5UX0NIQU5ORUxfVFlQRV9JRFM6IFs2LCA3XSxcbiAgICBDT05URU5UX0lURU1fVFlQRVM6IFtcbiAgICAgICdDb250ZW50SXRlbScsXG4gICAgICAnVW5pdmVyc2FsQ29udGVudEl0ZW0nLFxuICAgICAgJ0Rldm90aW9uYWxDb250ZW50SXRlbScsXG4gICAgICAnTWVkaWFDb250ZW50SXRlbScsXG4gICAgXSxcbiAgfSxcbiAgQVBQOiB7XG4gICAgREVFUF9MSU5LX0hPU1Q6ICdhcG9sbG9zY2h1cmNoJyxcbiAgfSxcbn0pO1xuXG5kZXNjcmliZSgnRm9sbG93aW5nJywgKCkgPT4ge1xuICBsZXQgc2NoZW1hO1xuICBsZXQgY29udGV4dDtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZmV0Y2gucmVzZXRNb2NrcygpO1xuICAgIGZldGNoLm1vY2tSb2NrRGF0YVNvdXJjZUFQSSgpO1xuICAgIHNjaGVtYSA9IGdldFNjaGVtYShbXG4gICAgICBjb250ZW50SXRlbVNjaGVtYSxcbiAgICAgIGNvbnRlbnRDaGFubmVsU2NoZW1hLFxuICAgICAgdGhlbWVTY2hlbWEsXG4gICAgICBzY3JpcHR1cmVTY2hlbWEsXG4gICAgXSk7XG4gICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHsgY29va2llOiAnc29tZS1jb29raWUnLCBzZXNzaW9uSWQ6IDEyMyB9KTtcbiAgICBjb250ZXh0ID0gZ2V0Q29udGV4dCh7XG4gICAgICByZXE6IHtcbiAgICAgICAgaGVhZGVyczogeyBhdXRob3JpemF0aW9uOiB0b2tlbiB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ2xpa2VzIGFuIGVudGl0eScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIG11dGF0aW9uIGxpa2VFbnRpdHkge1xuICAgICAgICB1cGRhdGVMaWtlRW50aXR5KFxuICAgICAgICAgIGlucHV0OiB7XG4gICAgICAgICAgICBub2RlSWQ6IFwiJHtjcmVhdGVHbG9iYWxJZCgxLCAnVW5pdmVyc2FsQ29udGVudEl0ZW0nKX1cIlxuICAgICAgICAgICAgb3BlcmF0aW9uOiBMaWtlXG4gICAgICAgICAgfVxuICAgICAgICApIHtcbiAgICAgICAgICBpZFxuICAgICAgICAgIGlzTGlrZWRcbiAgICAgICAgfVxuICAgICAgfVxuICAgIGA7XG4gICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHQpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcbiAgaXQoJ3VubGlrZXMgYW4gZW50aXR5JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgbXV0YXRpb24gbGlrZUVudGl0eSB7XG4gICAgICAgIHVwZGF0ZUxpa2VFbnRpdHkoXG4gICAgICAgICAgaW5wdXQ6IHtcbiAgICAgICAgICAgIG5vZGVJZDogXCIke2NyZWF0ZUdsb2JhbElkKDEsICdVbml2ZXJzYWxDb250ZW50SXRlbScpfVwiXG4gICAgICAgICAgICBvcGVyYXRpb246IFVubGlrZVxuICAgICAgICAgIH1cbiAgICAgICAgKSB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICBpc0xpa2VkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG4gIGl0KCd1c2VzIGZvbGxvd2luZyB0YWJsZSB0byB0cmFjayBpZiBhIHVzZXIgbGlrZWQgY29udGVudCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IGdldENvbnRlbnQge1xuICAgICAgICBub2RlKGlkOiBcIiR7Y3JlYXRlR2xvYmFsSWQoMSwgJ1VuaXZlcnNhbENvbnRlbnRJdGVtJyl9XCIpIHtcbiAgICAgICAgICBpZFxuICAgICAgICAgIC4uLiBvbiBDb250ZW50SXRlbSB7XG4gICAgICAgICAgICBpc0xpa2VkXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBjb25zdCByb290VmFsdWUgPSB7fTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBncmFwaHFsKHNjaGVtYSwgcXVlcnksIHJvb3RWYWx1ZSwgY29udGV4dCk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xuXG4gIGl0KCdyZXR1cm5zIGlzTGlrZWQgZmFsc2UgaWYgYSB1c2VyIGlzIGxvZ2dlZCBvdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcXVlcnkgPSBgXG4gICAgICBxdWVyeSBnZXRDb250ZW50IHtcbiAgICAgICAgbm9kZShpZDogXCIke2NyZWF0ZUdsb2JhbElkKDEsICdVbml2ZXJzYWxDb250ZW50SXRlbScpfVwiKSB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICAuLi4gb24gQ29udGVudEl0ZW0ge1xuICAgICAgICAgICAgaXNMaWtlZFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIGA7XG4gICAgY29uc3QgY29udGV4dFdpdGhvdXRVc2VyID0gZ2V0Q29udGV4dCgpO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0V2l0aG91dFVzZXIpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9KTtcblxuICBpdCgncmV0dXJucyBhIGxpa2VDb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IGdldENvbnRlbnQge1xuICAgICAgICBub2RlKGlkOiBcIiR7Y3JlYXRlR2xvYmFsSWQoMSwgJ1VuaXZlcnNhbENvbnRlbnRJdGVtJyl9XCIpIHtcbiAgICAgICAgICBpZFxuICAgICAgICAgIC4uLiBvbiBDb250ZW50SXRlbSB7XG4gICAgICAgICAgICBsaWtlZENvdW50XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBjb25zdCBjb250ZXh0V2l0aG91dFVzZXIgPSBnZXRDb250ZXh0KCk7XG4gICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHRXaXRob3V0VXNlcik7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xuXG4gIGl0KCdnZXRzIGFsbCB1c2VyIGxpa2VkIGNvbnRlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcXVlcnkgPSBgXG4gICAgICBxdWVyeSB7XG4gICAgICAgIGdldEFsbExpa2VkQ29udGVudCB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICBpc0xpa2VkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoJ3JldHVybnMgYW4gZW1wdHkgYXJyYXkgZm9yIGxpa2VkIGNvbnRlbnQgd2l0aG91dCBhIHVzZXIgbG9nZ2VkIGluJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgcXVlcnkge1xuICAgICAgICBnZXRBbGxMaWtlZENvbnRlbnQge1xuICAgICAgICAgIGlkXG4gICAgICAgICAgaXNMaWtlZFxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBjb25zdCBjb250ZXh0V2l0aG91dFVzZXIgPSBnZXRDb250ZXh0KCk7XG4gICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHRXaXRob3V0VXNlcik7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0pO1xufSk7XG4iXX0=