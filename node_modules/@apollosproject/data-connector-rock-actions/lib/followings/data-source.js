"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _apolloServer = require("apollo-server");

var _serverCore = require("@apollosproject/server-core");

var _rockApolloDataSource = _interopRequireDefault(require("@apollosproject/rock-apollo-data-source"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Followings extends _rockApolloDataSource.default {
  constructor(...args) {
    super(...args);

    _defineProperty(this, "resource", 'Followings');
  }

  async updateLikeContentItem({
    nodeId,
    operation
  }) {
    const {
      dataSources: {
        ContentItem
      }
    } = this.context;

    if (operation === 'Like') {
      await this.followNode({
        nodeId
      });
    } else {
      await this.unFollowNode({
        nodeId
      });
    }

    const {
      id
    } = (0, _serverCore.parseGlobalId)(nodeId);
    const item = await ContentItem.getFromId(id);
    return { ...item,
      isLiked: operation === 'Like'
    };
  }

  async followNode({
    nodeId
  }) {
    const {
      dataSources: {
        RockConstants,
        Auth
      }
    } = this.context;
    const {
      id,
      __type
    } = (0, _serverCore.parseGlobalId)(nodeId);
    const currentUser = await Auth.getCurrentPerson();
    const nodeType = await RockConstants.modelType(__type);
    const followingsId = await this.post('/Followings', {
      PersonAliasId: currentUser.primaryAliasId,
      EntityTypeId: nodeType.id,
      EntityId: id
    });
    return this.get(`/Followings/${followingsId}`);
  }

  async unFollowNode({
    nodeId
  }) {
    const {
      dataSources: {
        RockConstants,
        Auth
      }
    } = this.context;
    const {
      id,
      __type
    } = (0, _serverCore.parseGlobalId)(nodeId);
    const nodeType = await RockConstants.modelType(__type);
    const currentUser = await Auth.getCurrentPerson(); // currentUser.id is correct, this path does not use aliasId

    return this.delete(`/Followings/${nodeType.id}/${id}/${currentUser.id}`);
  }

  async getFollowingsCountByNodeId({
    nodeId
  }) {
    const {
      dataSources: {
        RockConstants
      }
    } = this.context;
    const {
      id,
      __type
    } = (0, _serverCore.parseGlobalId)(nodeId);
    const nodeType = await RockConstants.modelType(__type);
    return (await this.request('Followings').filter( // eslint-disable-next-line prettier/prettier
    `(EntityId eq ${id}) and (EntityTypeId eq ${nodeType.id})`).select('Id') // $count not supported, next best thing to make efficient
    .cache({
      ttl: 1800
    }) // TODO: whats the right way to do this?
    .get()).length;
  }

  async getFollowingsForCurrentUserAndNode({
    nodeId
  }) {
    const {
      dataSources: {
        RockConstants,
        Auth
      }
    } = this.context;
    const {
      id,
      __type
    } = (0, _serverCore.parseGlobalId)(nodeId);
    const nodeType = await RockConstants.modelType(__type);

    try {
      const currentUser = await Auth.getCurrentPerson();
      return this.request('Followings').filter( // eslint-disable-next-line prettier/prettier
      `(EntityId eq ${id}) and (EntityTypeId eq ${nodeType.id}) and (PersonAliasId eq ${currentUser.primaryAliasId})`).get();
    } catch (e) {
      if (e instanceof _apolloServer.AuthenticationError) {
        return [];
      }

      throw e;
    }
  }

  async getFollowingsForCurrentUser({
    type
  }) {
    const {
      dataSources: {
        RockConstants,
        Auth
      }
    } = this.context;
    const nodeType = await RockConstants.modelType(type);

    try {
      const currentUser = await Auth.getCurrentPerson();
      return this.request('Followings').filter( // eslint-disable-next-line prettier/prettier
      `(EntityTypeId eq ${nodeType.id}) and (PersonAliasId eq ${currentUser.primaryAliasId})`).get();
    } catch (e) {
      if (e instanceof _apolloServer.AuthenticationError) {
        return [];
      }

      throw e;
    }
  }

}

exports.default = Followings;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mb2xsb3dpbmdzL2RhdGEtc291cmNlLmpzIl0sIm5hbWVzIjpbIkZvbGxvd2luZ3MiLCJSb2NrQXBvbGxvRGF0YVNvdXJjZSIsInVwZGF0ZUxpa2VDb250ZW50SXRlbSIsIm5vZGVJZCIsIm9wZXJhdGlvbiIsImRhdGFTb3VyY2VzIiwiQ29udGVudEl0ZW0iLCJjb250ZXh0IiwiZm9sbG93Tm9kZSIsInVuRm9sbG93Tm9kZSIsImlkIiwiaXRlbSIsImdldEZyb21JZCIsImlzTGlrZWQiLCJSb2NrQ29uc3RhbnRzIiwiQXV0aCIsIl9fdHlwZSIsImN1cnJlbnRVc2VyIiwiZ2V0Q3VycmVudFBlcnNvbiIsIm5vZGVUeXBlIiwibW9kZWxUeXBlIiwiZm9sbG93aW5nc0lkIiwicG9zdCIsIlBlcnNvbkFsaWFzSWQiLCJwcmltYXJ5QWxpYXNJZCIsIkVudGl0eVR5cGVJZCIsIkVudGl0eUlkIiwiZ2V0IiwiZGVsZXRlIiwiZ2V0Rm9sbG93aW5nc0NvdW50QnlOb2RlSWQiLCJyZXF1ZXN0IiwiZmlsdGVyIiwic2VsZWN0IiwiY2FjaGUiLCJ0dGwiLCJsZW5ndGgiLCJnZXRGb2xsb3dpbmdzRm9yQ3VycmVudFVzZXJBbmROb2RlIiwiZSIsIkF1dGhlbnRpY2F0aW9uRXJyb3IiLCJnZXRGb2xsb3dpbmdzRm9yQ3VycmVudFVzZXIiLCJ0eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVlLE1BQU1BLFVBQU4sU0FBeUJDLDZCQUF6QixDQUE4QztBQUFBO0FBQUE7O0FBQUEsc0NBQ2hELFlBRGdEO0FBQUE7O0FBRzNELFFBQU1DLHFCQUFOLENBQTRCO0FBQUVDLElBQUFBLE1BQUY7QUFBVUMsSUFBQUE7QUFBVixHQUE1QixFQUFtRDtBQUNqRCxVQUFNO0FBQ0pDLE1BQUFBLFdBQVcsRUFBRTtBQUFFQyxRQUFBQTtBQUFGO0FBRFQsUUFFRixLQUFLQyxPQUZUOztBQUdBLFFBQUlILFNBQVMsS0FBSyxNQUFsQixF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LDBCQUFtQlosUUFBUSxDQUFDVCxFQUFHLDJCQUEwQk8sV0FBVyxDQUFDTyxjQUFlLEdBSGxGLEVBS0pHLEdBTEksRUFBUDtBQU1ELEtBUkQsQ0FRRSxPQUFPVSxDQUFQLEVBQVU7QUFDVixVQUFJQSxDQUFDLFlBQVlDLGlDQUFqQixFQUFzQztBQUNwQyxlQUFPLEVBQVA7QUFDRDs7QUFDRCxZQUFNRCxDQUFOO0FBQ0Q7QUFDRjs7QUE3RzBEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXV0aGVudGljYXRpb25FcnJvciB9IGZyb20gJ2Fwb2xsby1zZXJ2ZXInO1xuaW1wb3J0IHsgcGFyc2VHbG9iYWxJZCB9IGZyb20gJ0BhcG9sbG9zcHJvamVjdC9zZXJ2ZXItY29yZSc7XG5pbXBvcnQgUm9ja0Fwb2xsb0RhdGFTb3VyY2UgZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L3JvY2stYXBvbGxvLWRhdGEtc291cmNlJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRm9sbG93aW5ncyBleHRlbmRzIFJvY2tBcG9sbG9EYXRhU291cmNlIHtcbiAgcmVzb3VyY2UgPSAnRm9sbG93aW5ncyc7XG5cbiAgYXN5bmMgdXBkYXRlTGlrZUNvbnRlbnRJdGVtKHsgbm9kZUlkLCBvcGVyYXRpb24gfSkge1xuICAgIGNvbnN0IHtcbiAgICAgIGRhdGFTb3VyY2VzOiB7IENvbnRlbnRJdGVtIH0sXG4gICAgfSA9IHRoaXMuY29udGV4dDtcbiAgICBpZiAob3BlcmF0aW9uID09PSAnTGlrZScpIHtcbiAgICAgIGF3YWl0IHRoaXMuZm9sbG93Tm9kZSh7IG5vZGVJZCB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy51bkZvbGxvd05vZGUoeyBub2RlSWQgfSk7XG4gICAgfVxuICAgIGNvbnN0IHsgaWQgfSA9IHBhcnNlR2xvYmFsSWQobm9kZUlkKTtcbiAgICBjb25zdCBpdGVtID0gYXdhaXQgQ29udGVudEl0ZW0uZ2V0RnJvbUlkKGlkKTtcbiAgICByZXR1cm4geyAuLi5pdGVtLCBpc0xpa2VkOiBvcGVyYXRpb24gPT09ICdMaWtlJyB9O1xuICB9XG5cbiAgYXN5bmMgZm9sbG93Tm9kZSh7IG5vZGVJZCB9KSB7XG4gICAgY29uc3Qge1xuICAgICAgZGF0YVNvdXJjZXM6IHsgUm9ja0NvbnN0YW50cywgQXV0aCB9LFxuICAgIH0gPSB0aGlzLmNvbnRleHQ7XG4gICAgY29uc3QgeyBpZCwgX190eXBlIH0gPSBwYXJzZUdsb2JhbElkKG5vZGVJZCk7XG5cbiAgICBjb25zdCBjdXJyZW50VXNlciA9IGF3YWl0IEF1dGguZ2V0Q3VycmVudFBlcnNvbigpO1xuICAgIGNvbnN0IG5vZGVUeXBlID0gYXdhaXQgUm9ja0NvbnN0YW50cy5tb2RlbFR5cGUoX190eXBlKTtcblxuICAgIGNvbnN0IGZvbGxvd2luZ3NJZCA9IGF3YWl0IHRoaXMucG9zdCgnL0ZvbGxvd2luZ3MnLCB7XG4gICAgICBQZXJzb25BbGlhc0lkOiBjdXJyZW50VXNlci5wcmltYXJ5QWxpYXNJZCxcbiAgICAgIEVudGl0eVR5cGVJZDogbm9kZVR5cGUuaWQsXG4gICAgICBFbnRpdHlJZDogaWQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5nZXQoYC9Gb2xsb3dpbmdzLyR7Zm9sbG93aW5nc0lkfWApO1xuICB9XG5cbiAgYXN5bmMgdW5Gb2xsb3dOb2RlKHsgbm9kZUlkIH0pIHtcbiAgICBjb25zdCB7XG4gICAgICBkYXRhU291cmNlczogeyBSb2NrQ29uc3RhbnRzLCBBdXRoIH0sXG4gICAgfSA9IHRoaXMuY29udGV4dDtcblxuICAgIGNvbnN0IHsgaWQsIF9fdHlwZSB9ID0gcGFyc2VHbG9iYWxJZChub2RlSWQpO1xuICAgIGNvbnN0IG5vZGVUeXBlID0gYXdhaXQgUm9ja0NvbnN0YW50cy5tb2RlbFR5cGUoX190eXBlKTtcbiAgICBjb25zdCBjdXJyZW50VXNlciA9IGF3YWl0IEF1dGguZ2V0Q3VycmVudFBlcnNvbigpO1xuICAgIC8vIGN1cnJlbnRVc2VyLmlkIGlzIGNvcnJlY3QsIHRoaXMgcGF0aCBkb2VzIG5vdCB1c2UgYWxpYXNJZFxuICAgIHJldHVybiB0aGlzLmRlbGV0ZShgL0ZvbGxvd2luZ3MvJHtub2RlVHlwZS5pZH0vJHtpZH0vJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgfVxuXG4gIGFzeW5jIGdldEZvbGxvd2luZ3NDb3VudEJ5Tm9kZUlkKHsgbm9kZUlkIH0pIHtcbiAgICBjb25zdCB7XG4gICAgICBkYXRhU291cmNlczogeyBSb2NrQ29uc3RhbnRzIH0sXG4gICAgfSA9IHRoaXMuY29udGV4dDtcblxuICAgIGNvbnN0IHsgaWQsIF9fdHlwZSB9ID0gcGFyc2VHbG9iYWxJZChub2RlSWQpO1xuICAgIGNvbnN0IG5vZGVUeXBlID0gYXdhaXQgUm9ja0NvbnN0YW50cy5tb2RlbFR5cGUoX190eXBlKTtcblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5yZXF1ZXN0KCdGb2xsb3dpbmdzJylcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmV0dGllci9wcmV0dGllclxuICAgICAgICAgIGAoRW50aXR5SWQgZXEgJHtpZH0pIGFuZCAoRW50aXR5VHlwZUlkIGVxICR7bm9kZVR5cGUuaWR9KWBcbiAgICAgIClcbiAgICAgIC5zZWxlY3QoJ0lkJykgLy8gJGNvdW50IG5vdCBzdXBwb3J0ZWQsIG5leHQgYmVzdCB0aGluZyB0byBtYWtlIGVmZmljaWVudFxuICAgICAgLmNhY2hlKHsgdHRsOiAxODAwIH0pIC8vIFRPRE86IHdoYXRzIHRoZSByaWdodCB3YXkgdG8gZG8gdGhpcz9cbiAgICAgIC5nZXQoKSkubGVuZ3RoO1xuICB9XG5cbiAgYXN5bmMgZ2V0Rm9sbG93aW5nc0ZvckN1cnJlbnRVc2VyQW5kTm9kZSh7IG5vZGVJZCB9KSB7XG4gICAgY29uc3Qge1xuICAgICAgZGF0YVNvdXJjZXM6IHsgUm9ja0NvbnN0YW50cywgQXV0aCB9LFxuICAgIH0gPSB0aGlzLmNvbnRleHQ7XG5cbiAgICBjb25zdCB7IGlkLCBfX3R5cGUgfSA9IHBhcnNlR2xvYmFsSWQobm9kZUlkKTtcbiAgICBjb25zdCBub2RlVHlwZSA9IGF3YWl0IFJvY2tDb25zdGFudHMubW9kZWxUeXBlKF9fdHlwZSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gYXdhaXQgQXV0aC5nZXRDdXJyZW50UGVyc29uKCk7XG4gICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCdGb2xsb3dpbmdzJylcbiAgICAgICAgLmZpbHRlcihcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJldHRpZXIvcHJldHRpZXJcbiAgICAgICAgICBgKEVudGl0eUlkIGVxICR7aWR9KSBhbmQgKEVudGl0eVR5cGVJZCBlcSAke25vZGVUeXBlLmlkfSkgYW5kIChQZXJzb25BbGlhc0lkIGVxICR7Y3VycmVudFVzZXIucHJpbWFyeUFsaWFzSWR9KWBcbiAgICAgICAgKVxuICAgICAgICAuZ2V0KCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBBdXRoZW50aWNhdGlvbkVycm9yKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0Rm9sbG93aW5nc0ZvckN1cnJlbnRVc2VyKHsgdHlwZSB9KSB7XG4gICAgY29uc3Qge1xuICAgICAgZGF0YVNvdXJjZXM6IHsgUm9ja0NvbnN0YW50cywgQXV0aCB9LFxuICAgIH0gPSB0aGlzLmNvbnRleHQ7XG5cbiAgICBjb25zdCBub2RlVHlwZSA9IGF3YWl0IFJvY2tDb25zdGFudHMubW9kZWxUeXBlKHR5cGUpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gYXdhaXQgQXV0aC5nZXRDdXJyZW50UGVyc29uKCk7XG4gICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCdGb2xsb3dpbmdzJylcbiAgICAgICAgLmZpbHRlcihcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJldHRpZXIvcHJldHRpZXJcbiAgICAgICAgICBgKEVudGl0eVR5cGVJZCBlcSAke25vZGVUeXBlLmlkfSkgYW5kIChQZXJzb25BbGlhc0lkIGVxICR7Y3VycmVudFVzZXIucHJpbWFyeUFsaWFzSWR9KWBcbiAgICAgICAgKVxuICAgICAgICAuZ2V0KCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBBdXRoZW50aWNhdGlvbkVycm9yKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG59XG4iXX0=