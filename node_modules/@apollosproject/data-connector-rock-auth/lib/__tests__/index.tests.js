"use strict";

var _graphql = require("graphql");

var _apolloServerEnv = require("apollo-server-env");

var _config = _interopRequireDefault(require("@apollosproject/config"));

var _testUtils = require("@apollosproject/server-core/lib/testUtils");

var _dataSchema = require("@apollosproject/data-schema");

var Auth = _interopRequireWildcard(require("../index"));

var _token = require("../token");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_config.default.loadJs({
  ROCK: {
    API_URL: 'https://apollosrock.newspring.cc/api',
    API_TOKEN: 'some-rock-token'
  }
});

const {
  getContext,
  getSchema
} = (0, _testUtils.createTestHelpers)({
  Auth
});
describe('Auth', () => {
  let schema;
  let context;
  beforeEach(() => {
    _apolloServerEnv.fetch.resetMocks();

    _apolloServerEnv.fetch.mockRockDataSourceAPI();

    schema = getSchema([_dataSchema.peopleSchema, _dataSchema.mediaSchema]);
    context = getContext();
  });
  it('logs in a user', async () => {
    const query = `
      mutation {
        authenticate(identity: "some-identity", password: "good") {
          user {
            id
            profile {
              email
            }
          }
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  it('throws invalid credentials error on bad password', async () => {
    const query = `
      mutation {
        authenticate(identity: "some-identity", password: "bad") {
          user {
            id
          }
        }
      }
    `;
    const rootValue = {};
    const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
    expect(result).toMatchSnapshot();
  });
  describe('currentUser query', () => {
    const query = `
      query {
        currentUser {
          id
          profile {
            email
          }
        }
      }
    `;
    it('requires you to be logged in', async () => {
      const rootValue = {};
      const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
      expect(result).toMatchSnapshot();
    });
    it('queries current user when logged in', async () => {
      const rootValue = {};
      const token = (0, _token.generateToken)({
        cookie: 'some-cookie',
        sessionId: 123
      });
      context = getContext({
        req: {
          headers: {
            authorization: token
          }
        }
      });
      const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
      expect(result).toMatchSnapshot();
    });
    it('logs a user out without a sessionId', async () => {
      const rootValue = {};
      const token = (0, _token.generateToken)({
        cookie: 'some-cookie'
      });
      context = getContext({
        req: {
          headers: {
            authorization: token
          }
        }
      });
      const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
      expect(result).toMatchSnapshot();
    });
    it('queries current user when logged in', async () => {
      const rootValue = {};

      try {
        const {
          userToken,
          rockCookie
        } = (0, _token.registerToken)('asdfasdfasdf');
        context.userToken = userToken;
        context.rockCookie = rockCookie;
        await (0, _graphql.graphql)(schema, query, rootValue, context);
      } catch (e) {
        expect(e.message).toEqual('Invalid token');
      }
    });
  });
  it('registers an auth token and passes the cookie on requests to rock', async () => {
    const token = (0, _token.generateToken)({
      cookie: 'some-cookie',
      sessionId: 123
    });
    const secondContext = getContext({
      req: {
        headers: {
          authorization: token
        }
      }
    });
    const query = `
      query {
        currentUser {
          id
        }
      }
    `;
    const rootValue = {};
    await (0, _graphql.graphql)(schema, query, rootValue, secondContext);
    expect(_apolloServerEnv.fetch.mock.calls[0][0].headers).toMatchSnapshot();
  });
  describe('Change Password', () => {
    it('throws error without a current user', async () => {
      try {
        await context.dataSources.Auth.changePassword({
          password: 'newPassword'
        });
      } catch (e) {
        expect(e.message).toEqual('Must be logged in');
      }
    });
    it('generates a new token', async () => {
      const {
        userToken,
        rockCookie
      } = (0, _token.registerToken)((0, _token.generateToken)({
        cookie: 'some-cookie'
      }));
      context.userToken = userToken;
      context.rockCookie = rockCookie;
      const {
        rockCookie: newCookie,
        token: newToken
      } = await context.dataSources.Auth.changePassword({
        password: 'good'
      });
      expect(newCookie).toEqual('some cookie');
      expect(typeof newToken).toEqual('string');
    });
  });
  describe('User Registration', () => {
    it('checks if user is already registered', async () => {
      const result = await context.dataSources.Auth.personExists({
        identity: 'isaac.hardy@newspring.cc'
      });
      expect(result).toEqual(true);
    });
    it('throws error in personExists', async () => {
      const result = await context.dataSources.Auth.personExists({
        identity: 'fake'
      });
      expect(result).toEqual(false);
    });
    it('creates user profile', async () => {
      const result = await context.dataSources.Auth.createUserProfile({
        email: 'isaac.hardy@newspring.cc'
      });
      expect(result).toEqual('35');
    });
    it('throws error in createUserProfile', async () => {
      try {
        await context.dataSources.Auth.createUserProfile({
          email: ''
        });
      } catch (e) {
        expect(e.message).toEqual('Unable to create profile!');
      }
    });
    it('creates user login', async () => {
      const result = await context.dataSources.Auth.createUserLogin({
        email: 'isaac.hardy@newspring.cc',
        password: 'password',
        personId: 35
      });
      expect(result).toEqual({
        id: 21
      });
    });
    it('throws error in createUserLogin', async () => {
      try {
        await context.dataSources.Auth.createUserLogin({
          email: '',
          password: 'password',
          personId: 35
        });
      } catch (e) {
        expect(e.message).toEqual('Unable to create user login!');
      }
    });
    it('creates new registration', async () => {
      const query = `
        mutation {
          registerPerson(email: "hello.world@earth.org", password: "good") {
            user {
              id
              profile {
                email
              }
            }
          }
        }
      `;
      const rootValue = {};
      const result = await (0, _graphql.graphql)(schema, query, rootValue, context);
      expect(result).toMatchSnapshot();
    });
    it('passes the right args when creating a registration', async () => {
      const query = `
        mutation {
          registerPerson(email: "hello.world@earth.org", password: "good") {
            user {
              id
              profile {
                id
                email
              }
            }
          }
        }
      `;
      const createUserProfile = jest.fn().mockImplementation(async () => Promise.resolve('123'));
      const createUserLogin = jest.fn();
      const rootValue = {};
      context.dataSources.Auth.createUserLogin = createUserLogin;
      context.dataSources.Auth.createUserProfile = createUserProfile;
      await (0, _graphql.graphql)(schema, query, rootValue, context);
      expect(createUserProfile.mock.calls).toMatchSnapshot();
      expect(createUserLogin.mock.calls).toMatchSnapshot();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9fX3Rlc3RzX18vaW5kZXgudGVzdHMuanMiXSwibmFtZXMiOlsiQXBvbGxvc0NvbmZpZyIsImxvYWRKcyIsIlJPQ0siLCJBUElfVVJMIiwiQVBJX1RPS0VOIiwiZ2V0Q29udGV4dCIsImdldFNjaGVtYSIsIkF1dGgiLCJkZXNjcmliZSIsInNjaGVtYSIsImNvbnRleHQiLCJiZWZvcmVFYWNoIiwiZmV0Y2giLCJyZXNldE1vY2tzIiwibW9ja1JvY2tEYXRhU291cmNlQVBJIiwicGVvcGxlU2NoZW1hIiwibWVkaWFTY2hlbWEiLCJpdCIsInF1ZXJ5Iiwicm9vdFZhbHVlIiwicmVzdWx0IiwiZXhwZWN0IiwidG9NYXRjaFNuYXBzaG90IiwidG9rZW4iLCJjb29raWUiLCJzZXNzaW9uSWQiLCJyZXEiLCJoZWFkZXJzIiwiYXV0aG9yaXphdGlvbiIsInVzZXJUb2tlbiIsInJvY2tDb29raWUiLCJlIiwibWVzc2FnZSIsInRvRXF1YWwiLCJzZWNvbmRDb250ZXh0IiwibW9jayIsImNhbGxzIiwiZGF0YVNvdXJjZXMiLCJjaGFuZ2VQYXNzd29yZCIsInBhc3N3b3JkIiwibmV3Q29va2llIiwibmV3VG9rZW4iLCJwZXJzb25FeGlzdHMiLCJpZGVudGl0eSIsImNyZWF0ZVVzZXJQcm9maWxlIiwiZW1haWwiLCJjcmVhdGVVc2VyTG9naW4iLCJwZXJzb25JZCIsImlkIiwiamVzdCIsImZuIiwibW9ja0ltcGxlbWVudGF0aW9uIiwiUHJvbWlzZSIsInJlc29sdmUiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7OztBQUVBQSxnQkFBY0MsTUFBZCxDQUFxQjtBQUNuQkMsRUFBQUEsSUFBSSxFQUFFO0FBQ0pDLElBQUFBLE9BQU8sRUFBRSxzQ0FETDtBQUVKQyxJQUFBQSxTQUFTLEVBQUU7QUFGUDtBQURhLENBQXJCOztBQU9BLE1BQU07QUFBRUMsRUFBQUEsVUFBRjtBQUFjQyxFQUFBQTtBQUFk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dCI6WyJpbXBvcnQgeyBncmFwaHFsIH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgeyBmZXRjaCB9IGZyb20gJ2Fwb2xsby1zZXJ2ZXItZW52JztcbmltcG9ydCBBcG9sbG9zQ29uZmlnIGZyb20gJ0BhcG9sbG9zcHJvamVjdC9jb25maWcnO1xuaW1wb3J0IHsgY3JlYXRlVGVzdEhlbHBlcnMgfSBmcm9tICdAYXBvbGxvc3Byb2plY3Qvc2VydmVyLWNvcmUvbGliL3Rlc3RVdGlscyc7XG5pbXBvcnQgeyBwZW9wbGVTY2hlbWEsIG1lZGlhU2NoZW1hIH0gZnJvbSAnQGFwb2xsb3Nwcm9qZWN0L2RhdGEtc2NoZW1hJztcblxuaW1wb3J0ICogYXMgQXV0aCBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgeyBnZW5lcmF0ZVRva2VuLCByZWdpc3RlclRva2VuIH0gZnJvbSAnLi4vdG9rZW4nO1xuXG5BcG9sbG9zQ29uZmlnLmxvYWRKcyh7XG4gIFJPQ0s6IHtcbiAgICBBUElfVVJMOiAnaHR0cHM6Ly9hcG9sbG9zcm9jay5uZXdzcHJpbmcuY2MvYXBpJyxcbiAgICBBUElfVE9LRU46ICdzb21lLXJvY2stdG9rZW4nLFxuICB9LFxufSk7XG5cbmNvbnN0IHsgZ2V0Q29udGV4dCwgZ2V0U2NoZW1hIH0gPSBjcmVhdGVUZXN0SGVscGVycyh7IEF1dGggfSk7XG5cbmRlc2NyaWJlKCdBdXRoJywgKCkgPT4ge1xuICBsZXQgc2NoZW1hO1xuICBsZXQgY29udGV4dDtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZmV0Y2gucmVzZXRNb2NrcygpO1xuICAgIGZldGNoLm1vY2tSb2NrRGF0YVNvdXJjZUFQSSgpO1xuICAgIHNjaGVtYSA9IGdldFNjaGVtYShbcGVvcGxlU2NoZW1hLCBtZWRpYVNjaGVtYV0pO1xuICAgIGNvbnRleHQgPSBnZXRDb250ZXh0KCk7XG4gIH0pO1xuXG4gIGl0KCdsb2dzIGluIGEgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIG11dGF0aW9uIHtcbiAgICAgICAgYXV0aGVudGljYXRlKGlkZW50aXR5OiBcInNvbWUtaWRlbnRpdHlcIiwgcGFzc3dvcmQ6IFwiZ29vZFwiKSB7XG4gICAgICAgICAgdXNlciB7XG4gICAgICAgICAgICBpZFxuICAgICAgICAgICAgcHJvZmlsZSB7XG4gICAgICAgICAgICAgIGVtYWlsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBjb25zdCByb290VmFsdWUgPSB7fTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgaXQoJ3Rocm93cyBpbnZhbGlkIGNyZWRlbnRpYWxzIGVycm9yIG9uIGJhZCBwYXNzd29yZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIG11dGF0aW9uIHtcbiAgICAgICAgYXV0aGVudGljYXRlKGlkZW50aXR5OiBcInNvbWUtaWRlbnRpdHlcIiwgcGFzc3dvcmQ6IFwiYmFkXCIpIHtcbiAgICAgICAgICB1c2VyIHtcbiAgICAgICAgICAgIGlkXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBjb25zdCByb290VmFsdWUgPSB7fTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2N1cnJlbnRVc2VyIHF1ZXJ5JywgKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgcXVlcnkge1xuICAgICAgICBjdXJyZW50VXNlciB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICBwcm9maWxlIHtcbiAgICAgICAgICAgIGVtYWlsXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcbiAgICBpdCgncmVxdWlyZXMgeW91IHRvIGJlIGxvZ2dlZCBpbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBncmFwaHFsKHNjaGVtYSwgcXVlcnksIHJvb3RWYWx1ZSwgY29udGV4dCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b01hdGNoU25hcHNob3QoKTtcbiAgICB9KTtcblxuICAgIGl0KCdxdWVyaWVzIGN1cnJlbnQgdXNlciB3aGVuIGxvZ2dlZCBpbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHsgY29va2llOiAnc29tZS1jb29raWUnLCBzZXNzaW9uSWQ6IDEyMyB9KTtcblxuICAgICAgY29udGV4dCA9IGdldENvbnRleHQoe1xuICAgICAgICByZXE6IHtcbiAgICAgICAgICBoZWFkZXJzOiB7IGF1dGhvcml6YXRpb246IHRva2VuIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3JhcGhxbChzY2hlbWEsIHF1ZXJ5LCByb290VmFsdWUsIGNvbnRleHQpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaFNuYXBzaG90KCk7XG4gICAgfSk7XG5cbiAgICBpdCgnbG9ncyBhIHVzZXIgb3V0IHdpdGhvdXQgYSBzZXNzaW9uSWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByb290VmFsdWUgPSB7fTtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVUb2tlbih7IGNvb2tpZTogJ3NvbWUtY29va2llJyB9KTtcbiAgICAgIGNvbnRleHQgPSBnZXRDb250ZXh0KHtcbiAgICAgICAgcmVxOiB7XG4gICAgICAgICAgaGVhZGVyczogeyBhdXRob3JpemF0aW9uOiB0b2tlbiB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3F1ZXJpZXMgY3VycmVudCB1c2VyIHdoZW4gbG9nZ2VkIGluJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IHVzZXJUb2tlbiwgcm9ja0Nvb2tpZSB9ID0gcmVnaXN0ZXJUb2tlbignYXNkZmFzZGZhc2RmJyk7XG4gICAgICAgIGNvbnRleHQudXNlclRva2VuID0gdXNlclRva2VuO1xuICAgICAgICBjb250ZXh0LnJvY2tDb29raWUgPSByb2NrQ29va2llO1xuXG4gICAgICAgIGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9FcXVhbCgnSW52YWxpZCB0b2tlbicpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBpdCgncmVnaXN0ZXJzIGFuIGF1dGggdG9rZW4gYW5kIHBhc3NlcyB0aGUgY29va2llIG9uIHJlcXVlc3RzIHRvIHJvY2snLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZVRva2VuKHsgY29va2llOiAnc29tZS1jb29raWUnLCBzZXNzaW9uSWQ6IDEyMyB9KTtcbiAgICBjb25zdCBzZWNvbmRDb250ZXh0ID0gZ2V0Q29udGV4dCh7XG4gICAgICByZXE6IHtcbiAgICAgICAgaGVhZGVyczogeyBhdXRob3JpemF0aW9uOiB0b2tlbiB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIHF1ZXJ5IHtcbiAgICAgICAgY3VycmVudFVzZXIge1xuICAgICAgICAgIGlkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBgO1xuICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuICAgIGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBzZWNvbmRDb250ZXh0KTtcbiAgICBleHBlY3QoZmV0Y2gubW9jay5jYWxsc1swXVswXS5oZWFkZXJzKS50b01hdGNoU25hcHNob3QoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NoYW5nZSBQYXNzd29yZCcsICgpID0+IHtcbiAgICBpdCgndGhyb3dzIGVycm9yIHdpdGhvdXQgYSBjdXJyZW50IHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjb250ZXh0LmRhdGFTb3VyY2VzLkF1dGguY2hhbmdlUGFzc3dvcmQoe1xuICAgICAgICAgIHBhc3N3b3JkOiAnbmV3UGFzc3dvcmQnLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9FcXVhbCgnTXVzdCBiZSBsb2dnZWQgaW4nKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdnZW5lcmF0ZXMgYSBuZXcgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IHVzZXJUb2tlbiwgcm9ja0Nvb2tpZSB9ID0gcmVnaXN0ZXJUb2tlbihcbiAgICAgICAgZ2VuZXJhdGVUb2tlbih7IGNvb2tpZTogJ3NvbWUtY29va2llJyB9KVxuICAgICAgKTtcbiAgICAgIGNvbnRleHQudXNlclRva2VuID0gdXNlclRva2VuO1xuICAgICAgY29udGV4dC5yb2NrQ29va2llID0gcm9ja0Nvb2tpZTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgcm9ja0Nvb2tpZTogbmV3Q29va2llLFxuICAgICAgICB0b2tlbjogbmV3VG9rZW4sXG4gICAgICB9ID0gYXdhaXQgY29udGV4dC5kYXRhU291cmNlcy5BdXRoLmNoYW5nZVBhc3N3b3JkKHtcbiAgICAgICAgcGFzc3dvcmQ6ICdnb29kJyxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KG5ld0Nvb2tpZSkudG9FcXVhbCgnc29tZSBjb29raWUnKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgbmV3VG9rZW4pLnRvRXF1YWwoJ3N0cmluZycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnVXNlciBSZWdpc3RyYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ2NoZWNrcyBpZiB1c2VyIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbnRleHQuZGF0YVNvdXJjZXMuQXV0aC5wZXJzb25FeGlzdHMoe1xuICAgICAgICBpZGVudGl0eTogJ2lzYWFjLmhhcmR5QG5ld3NwcmluZy5jYycsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCd0aHJvd3MgZXJyb3IgaW4gcGVyc29uRXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29udGV4dC5kYXRhU291cmNlcy5BdXRoLnBlcnNvbkV4aXN0cyh7XG4gICAgICAgIGlkZW50aXR5OiAnZmFrZScsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnY3JlYXRlcyB1c2VyIHByb2ZpbGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb250ZXh0LmRhdGFTb3VyY2VzLkF1dGguY3JlYXRlVXNlclByb2ZpbGUoe1xuICAgICAgICBlbWFpbDogJ2lzYWFjLmhhcmR5QG5ld3NwcmluZy5jYycsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCgnMzUnKTtcbiAgICB9KTtcblxuICAgIGl0KCd0aHJvd3MgZXJyb3IgaW4gY3JlYXRlVXNlclByb2ZpbGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjb250ZXh0LmRhdGFTb3VyY2VzLkF1dGguY3JlYXRlVXNlclByb2ZpbGUoe1xuICAgICAgICAgIGVtYWlsOiAnJyxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvRXF1YWwoJ1VuYWJsZSB0byBjcmVhdGUgcHJvZmlsZSEnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdjcmVhdGVzIHVzZXIgbG9naW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb250ZXh0LmRhdGFTb3VyY2VzLkF1dGguY3JlYXRlVXNlckxvZ2luKHtcbiAgICAgICAgZW1haWw6ICdpc2FhYy5oYXJkeUBuZXdzcHJpbmcuY2MnLFxuICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgcGVyc29uSWQ6IDM1LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyBpZDogMjEgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgndGhyb3dzIGVycm9yIGluIGNyZWF0ZVVzZXJMb2dpbicsIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGNvbnRleHQuZGF0YVNvdXJjZXMuQXV0aC5jcmVhdGVVc2VyTG9naW4oe1xuICAgICAgICAgIGVtYWlsOiAnJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICBwZXJzb25JZDogMzUsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBleHBlY3QoZS5tZXNzYWdlKS50b0VxdWFsKCdVbmFibGUgdG8gY3JlYXRlIHVzZXIgbG9naW4hJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnY3JlYXRlcyBuZXcgcmVnaXN0cmF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnkgPSBgXG4gICAgICAgIG11dGF0aW9uIHtcbiAgICAgICAgICByZWdpc3RlclBlcnNvbihlbWFpbDogXCJoZWxsby53b3JsZEBlYXJ0aC5vcmdcIiwgcGFzc3dvcmQ6IFwiZ29vZFwiKSB7XG4gICAgICAgICAgICB1c2VyIHtcbiAgICAgICAgICAgICAgaWRcbiAgICAgICAgICAgICAgcHJvZmlsZSB7XG4gICAgICAgICAgICAgICAgZW1haWxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgYDtcblxuICAgICAgY29uc3Qgcm9vdFZhbHVlID0ge307XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Bhc3NlcyB0aGUgcmlnaHQgYXJncyB3aGVuIGNyZWF0aW5nIGEgcmVnaXN0cmF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnkgPSBgXG4gICAgICAgIG11dGF0aW9uIHtcbiAgICAgICAgICByZWdpc3RlclBlcnNvbihlbWFpbDogXCJoZWxsby53b3JsZEBlYXJ0aC5vcmdcIiwgcGFzc3dvcmQ6IFwiZ29vZFwiKSB7XG4gICAgICAgICAgICB1c2VyIHtcbiAgICAgICAgICAgICAgaWRcbiAgICAgICAgICAgICAgcHJvZmlsZSB7XG4gICAgICAgICAgICAgICAgaWRcbiAgICAgICAgICAgICAgICBlbWFpbFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBgO1xuXG4gICAgICBjb25zdCBjcmVhdGVVc2VyUHJvZmlsZSA9IGplc3RcbiAgICAgICAgLmZuKClcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiBQcm9taXNlLnJlc29sdmUoJzEyMycpKTtcbiAgICAgIGNvbnN0IGNyZWF0ZVVzZXJMb2dpbiA9IGplc3QuZm4oKTtcbiAgICAgIGNvbnN0IHJvb3RWYWx1ZSA9IHt9O1xuXG4gICAgICBjb250ZXh0LmRhdGFTb3VyY2VzLkF1dGguY3JlYXRlVXNlckxvZ2luID0gY3JlYXRlVXNlckxvZ2luO1xuICAgICAgY29udGV4dC5kYXRhU291cmNlcy5BdXRoLmNyZWF0ZVVzZXJQcm9maWxlID0gY3JlYXRlVXNlclByb2ZpbGU7XG5cbiAgICAgIGF3YWl0IGdyYXBocWwoc2NoZW1hLCBxdWVyeSwgcm9vdFZhbHVlLCBjb250ZXh0KTtcblxuICAgICAgZXhwZWN0KGNyZWF0ZVVzZXJQcm9maWxlLm1vY2suY2FsbHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICAgICAgZXhwZWN0KGNyZWF0ZVVzZXJMb2dpbi5tb2NrLmNhbGxzKS50b01hdGNoU25hcHNob3QoKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==